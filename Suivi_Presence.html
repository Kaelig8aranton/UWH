<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suivi de Présences Sportives</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    main {
      flex: 1 1 auto;
      padding-bottom: 60px; /* espace pour la nav */
    }
    .tab {
      display: none;
      padding: 16px;
    }
    .tab.active {
      display: block;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      min-width: 0;
      height: 48px;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      padding: 0;
    }
    .nav-btn {
      flex: 1 1 0;
      min-width: 0;
      max-width: 25vw;
      text-align: center;
      color: #888;
      font-size: 14px;
      padding: 0;
      margin: 0;
      background: none;
      border: none;
      outline: none;
      cursor: pointer;
      transition: color 0.2s;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .nav-btn.active {
      color: #1976d2;
      font-weight: bold;
    }
    .nav-btn span {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      font-size: 22px;
    }
    /* Pour le bouton + */
    .add-btn {
      position: fixed;
      right: 24px;
      bottom: 80px;
      background: var(--secondary, #1976d2) !important;
      color: #fff !important;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 101;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .add-btn:hover,
    .add-btn:active,
    .add-btn:focus {
      background: #1251a3 !important;
    }
    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .modal-backdrop {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
    }
    .modal-content {
      position: relative;
      background: #fff;
      border-radius: 12px;
      padding: 24px 16px 16px 16px;
      min-width: 280px;
      max-width: 95vw;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
      z-index: 201;
      max-height: 90vh;
      overflow-y: auto;
      padding-bottom: 80px;
    }
    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1.2em;
    }
    .modal-content label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.98em;
    }
    .modal-content input, .modal-content select {
      width: 100%;
      margin-top: 2px;
      margin-bottom: 8px;
      padding: 6px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .modal-content button {
      margin-left: 8px;
      padding: 6px 16px;
      font-size: 1em;
      border-radius: 4px;
      border: none;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal-content button[type="button"] {
      background: #aaa;
    }
    .modal-content button[type="button"]:hover {
      background: #888;
    }
    .modal-content button[type="submit"]:hover {
      background: #1251a3;
    }
    #timeline-content {
      max-height: calc(100vh - 170px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .checkbox-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      min-height: 36px;
      height: 36px;
      padding: 0 0;
      border-bottom: 1px solid #e0e0e0;
      background: #fff;
    }
    .checkbox-row:nth-child(even) {
      background: #f7f7f7;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      margin: 0;
      min-width: 120px;
      flex: 1;
      height: 100%;
      /* debug */
      /* background: #e0f7fa; */
    }
    .checkbox-label input[type="checkbox"] {
      margin-right: 8px;
      margin-bottom: 0;
      vertical-align: middle;
      height: 18px;
      width: 18px;
      /* background: #ffe0b2; */
    }
    .checkbox-label span, .checkbox-label input {
      vertical-align: middle;
    }
    .checkbox-label br { display: none; }
    .checkbox-label span, .checkbox-label-text {
      padding-top: 4px;
      display: inline-block;
    }
  </style>
  <style>
    @media (max-width: 600px) {
      .modal-content {
        max-height: 90vh;
        overflow-y: auto;
        padding-bottom: 80px;
      }
      .modal-content form > div[style*="text-align:right;"] {
        position: sticky;
        bottom: 0;
        background: var(--card, #fff);
        padding-bottom: 8px;
        margin-bottom: -8px;
        z-index: 2;
      }
    }
  </style>
  <style>
    #timeline-split {
      display: flex;
      flex-direction: row;
    }
    #timeline-split-list {
      min-width: unset !important;
      max-width: 20vw !important;
      flex: 0 0 20vw !important;
      font-size: 0.75em !important;
      padding-right: 2px;
    }
    #timeline-split-list .event-card.timeline-compact {
      font-size: 0.85em !important;
      padding: 6px 2px !important;
      margin-bottom: 6px !important;
    }
    #timeline-split-detail {
      min-width: 0 !important;
      max-width: 80vw !important;
      flex: 1 1 80vw !important;
    }
  </style>
  <style>
    /* Couleur secondaire par défaut */
    :root {
      --secondary: #1976d2;
    }

    /* Barre de navigation du bas : couleur secondaire, pas de fond au clic */
    .bottom-nav .nav-btn {
      color: var(--secondary, #1976d2) !important;
      background: none !important;
      transition: color 0.2s;
    }
    .bottom-nav .nav-btn:active,
    .bottom-nav .nav-btn:focus {
      color: #1251a3 !important;
      background: none !important;
    }
    .bottom-nav .nav-btn.active {
      color: var(--secondary, #1976d2) !important;
      font-weight: bold;
      background: none !important;
    }

    /* Boutons "Modifier" */
    .edit-event-btn,
    #player-edit-btn,
    #team-edit-btn {
      background: var(--secondary, #1976d2) !important;
      color: #fff !important;
      border: none;
      border-radius: 4px;
      padding: 4px 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .edit-event-btn:hover,
    #player-edit-btn:hover,
    #team-edit-btn:hover {
      background: #1251a3 !important;
    }

    /* Noms des joueurs et équipes (dans les listes, fiches, etc.) */
    .player-card span,
    .team-card span,
    #team-details span,
    #player-details span,
    .event-card .player-name,
    .event-card .team-name {
      color: var(--secondary, #1976d2) !important;
      font-weight: 500;
    }

    /* Dates et descriptions d'événements */
    .event-card strong,
    .event-card .event-date,
    .event-card .event-description {
      color: var(--secondary, #1976d2) !important;
    }

    /* Autres boutons d'action */
    button,
    input[type="button"],
    input[type="submit"] {
      border-radius: 4px;
      border: none;
      background: var(--secondary, #1976d2);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover,
    input[type="button"]:hover,
    input[type="submit"]:hover {
      background: #1251a3;
    }

    /* Pour les pastilles de couleur secondaire dans les paramètres */
    .color-preset[style*="background"] {
      border-color: var(--secondary, #1976d2);
    } 

    /* Noms des joueurs et équipes dans les vues détaillées et mixtes */
    .event-card.timeline-detailed label[for],
    .event-card.timeline-detailed label,
    .event-card.timeline-detailed span,
    .event-card.timeline-detailed .player-name,
    .event-card.timeline-detailed .team-name {
      color: var(--secondary, #1976d2) !important;
      font-weight: 500;
    }

    /* Champ commentaire dans les fiches évènement (détaillée/mixte) */
    .event-card.timeline-detailed input[type="text"][data-type="comment"] {
      background: transparent;
      border: 1px solid #ccc;
      color: var(--secondary, #1976d2);
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 4px;
      transition: border 0.2s;
    }
    .event-card.timeline-detailed input[type="text"][data-type="comment"]:focus {
      border: 1.5px solid var(--secondary, #1976d2);
      outline: none;
    } 
  </style>
  <style>
    :root[data-theme='dark'] {
      --bg: #181a20;
      --fg: #f5f5f5;
      --card: #232634;
      --border: #333;
      --primary: #90caf9;
    }
    :root[data-theme='oled'] {
      --bg: #000;
      --fg: #fff;
      --card: #111;
      --border: #222;
      --primary: #00e676;
    }
    :root[data-theme='light'], :root:not([data-theme]) {
      --bg: #f5f5f5;
      --fg: #181a20;
      --card: #fff;
      --border: #ddd;
      --primary: #1976d2;
    }
    body { background: var(--bg); color: var(--fg); }
    .event-card, .player-card, .team-card, .modal-content { background: var(--card)!important; color: var(--fg)!important; border-color: var(--border)!important; }
    .checkbox-row { background: var(--card)!important; }
    .checkbox-row:nth-child(even) { background: #e3eafc22!important; }
    .bottom-nav { background: var(--card)!important; border-top: 1px solid var(--border)!important; }
    .nav-btn.active { color: var(--primary)!important; }
    .add-btn { background: var(--secondary, var(--primary, #1976d2))!important; }
    a, .nav-btn { color: var(--primary); }
  </style>
  <!-- Ajout d'un style CSS pour la popup et la zone de clic -->
  <style>
    .weekly-graph-popup {
      background: var(--background, #fff) !important;
      color: var(--text, #222) !important;
      border: 1px solid var(--secondary, #1976d2) !important;
      box-shadow: 0 2px 8px #0002 !important;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.98em;
      z-index: 10;
    }
    .weekly-graph-barzone {
      cursor: pointer;
      fill: transparent;
    }
  </style>
</head>
<body>
  <script>
    // --- Traduction FR/EN/ES ---
    const translations = {
      fr: {
        'Thème visuel :': 'Thème visuel :',
        'Système': 'Système',
        'Clair': 'Clair',
        'Sombre': 'Sombre',
        'Noir OLED': 'Noir OLED',
        "Inverser l'ordre de la Timeline": "Inverser l'ordre de la Timeline",
        'Export / Import des données :': 'Export / Import des données :',
        'Exporter': 'Exporter',
        'Importer': 'Importer',
        'Remplacer': 'Remplacer',
        'Fusionner': 'Fusionner',
        'Langue :': 'Langue :',
        'Français': 'Français',
        'English': 'Anglais',
        'Español': 'Espagnol',
        'Exemple de JSON :': 'Exemple de JSON :',
        'Copier': 'Copier',
        'Copié !': 'Copié !',
        'Tout supprimer': 'Tout supprimer',
        "Erreur lors de l'import : ": "Erreur lors de l'import : ",
        'Remplacer toutes les données existantes par celles du fichier ?': 'Remplacer toutes les données existantes par celles du fichier ?',
        // Interface générale
        'timeline_title': 'Timeline',
        'teams_title': 'Équipes',
        'players_title': 'Joueurs',
        'settings_title': 'Paramètres',
        'add_event': 'Ajouter un événement',
        'add_team': 'Ajouter une équipe',
        'add_player': 'Ajouter un joueur',
        'event_modal_title': 'Nouvel événement',
        'event_date': 'Date :',
        'event_date_end': 'Date fin (optionnel) :',
        'event_start_time': 'Heure de début :',
        'event_end_time': 'Heure de fin :',
        'event_description': 'Description :',
        'event_championnat_type': 'Type :',
        'event_categorie': 'Catégorie :',
        'event_description_autre': 'Autre description :',
        'event_equipes': 'Équipes conviées :',
        'add_players_case': 'Ajouter des joueurs au cas par cas',
        'event_players_invited': 'Joueurs invités :',
        'event_recurrence': 'Récurrence :',
        'event_recurrence_enddate': 'Date de fin de récurrence :',
        'event_lieu': 'Lieu (optionnel) :',
        'cancel': 'Annuler',
        'save': 'Enregistrer',
        'player_modal_title': 'Nouveau joueur',
        'player_name': 'Nom ou pseudo* :',
        'player_birth': 'Date de naissance :',
        'player_phone': 'Téléphone :',
        'player_email': 'Email(s) :',
        'player_teams': 'Affectation équipe(s) :',
        'desc_sousleau': "Sous l'eau",
        'desc_video': "Séance vidéo",
        'desc_course': "Course",
        'desc_renfo': "Renfo",
        'desc_stage': "Stage",
        'desc_tournois': "Tournois",
        'desc_championnat': "Championnat",
        'desc_autre': "Autre…",
        'timeline_view_mode': "Affichage de la Timeline :",
        'timeline_view_compact': "Vue compacte",
        'timeline_view_detailed': "Vue détaillée",
        'timeline_view_split': "Vue mixte (compacte + détaillée)",
        // --- AJOUTS NOUVEAUX TEXTES ---
        // Statistiques et fiches
        'total_presences': 'Présences totales :',
        'total_time': 'Temps total :',
        'season_presences': 'Présences cette saison :',
        'season_time': 'Temps cette saison :',
        'weekly_stats': 'Présences/temps par semaine :',
        'season_history': 'Historique par saison :',
        'edit': 'Modifier',
        'back': 'Retour',
        'teams': 'Équipes :',
        'players': 'Joueurs :',
        'no_data': 'Aucune donnée',
        'week': 'Semaine',
        'sessions_count': 'Nombre de séances :',
        'minutes': 'Temps :',
        // Corbeille et actions
        'trash_empty': 'Corbeille vide.',
        'empty_trash': 'Vider la corbeille',
        'restore': 'Restaurer',
        'deleted_events': 'Événements supprimés',
        'deleted_teams': 'Équipes supprimées',
        'deleted_players': 'Joueurs supprimés',
        'delete': 'Supprimer',
        'restore_all': 'Tout restaurer',
        'confirm_delete_all': 'Supprimer définitivement TOUS les événements et vider la corbeille ?',
        'confirm_delete_event': 'Supprimer cet événement ? Il sera placé dans la corbeille.',
        'confirm_empty_trash': 'Vider définitivement la corbeille ?',
        // Popup graphique
        'week_popup': 'Semaine',
        'sessions_popup': 'Nombre de séances :',
        'minutes_popup': 'Temps :',
        // Présences
        'presences': 'Présences :',
        'present_teams': 'Équipes présentes :',
        'present_players': 'Joueurs présents :',
        'comment': 'Commentaire :',
      },
      en: {
        'Thème visuel :': 'Theme:',
        'Système': 'System',
        'Clair': 'Light',
        'Sombre': 'Dark',
        'Noir OLED': 'OLED Black',
        "Inverser l'ordre de la Timeline": "Reverse Timeline Order",
        'Export / Import des données :': 'Export / Import data:',
        'Exporter': 'Export',
        'Importer': 'Import',
        'Remplacer': 'Replace',
        'Fusionner': 'Merge',
        'Langue :': 'Language:',
        'Français': 'French',
        'English': 'English',
        'Español': 'Spanish',
        'Exemple de JSON :': 'JSON Example:',
        'Copier': 'Copy',
        'Copié !': 'Copied!',
        'Tout supprimer': 'Delete all',
        "Erreur lors de l'import : ": 'Import error: ',
        'Remplacer toutes les données existantes par celles du fichier ?': 'Replace all existing data with file content?',
        // Interface générale
        'timeline_title': 'Timeline',
        'teams_title': 'Teams',
        'players_title': 'Players',
        'settings_title': 'Settings',
        'add_event': 'Add event',
        'add_team': 'Add team',
        'add_player': 'Add player',
        'event_modal_title': 'New event',
        'event_date': 'Date:',
        'event_date_end': 'End date (optional):',
        'event_start_time': 'Start time:',
        'event_end_time': 'End time:',
        'event_description': 'Description:',
        'event_championnat_type': 'Type:',
        'event_categorie': 'Category:',
        'event_description_autre': 'Other description:',
        'event_equipes': 'Invited teams:',
        'add_players_case': 'Add players individually',
        'event_players_invited': 'Invited players:',
        'event_recurrence': 'Recurrence:',
        'event_recurrence_enddate': 'Recurrence end date:',
        'event_lieu': 'Location (optional):',
        'cancel': 'Cancel',
        'save': 'Save',
        'player_modal_title': 'New player',
        'player_name': 'Name or nickname*:',
        'player_birth': 'Birth date:',
        'player_phone': 'Phone:',
        'player_email': 'Email(s):',
        'player_teams': 'Assigned team(s):',
        'desc_sousleau': "Underwater",
        'desc_video': "Video session",
        'desc_course': "Running",
        'desc_renfo': "Strength",
        'desc_stage': "Training camp",
        'desc_tournois': "Tournament",
        'desc_championnat': "Championship",
        'desc_autre': "Other...",
        'timeline_view_mode': "Timeline view mode:",
        'timeline_view_compact': "Compact view",
        'timeline_view_detailed': "Detailed view",
        'timeline_view_split': "Split view (compact + detailed)",
        // --- NEW TEXTS ---
        'total_presences': 'Total presences:',
        'total_time': 'Total time:',
        'season_presences': 'Presences this season:',
        'season_time': 'Time this season:',
        'weekly_stats': 'Presences/time per week:',
        'season_history': 'History by season:',
        'edit': 'Edit',
        'back': 'Back',
        'teams': 'Teams:',
        'players': 'Players:',
        'no_data': 'No data',
        'week': 'Week',
        'sessions_count': 'Number of sessions:',
        'minutes': 'Time:',
        // Trash and actions
        'trash_empty': 'Trash empty.',
        'empty_trash': 'Empty trash',
        'restore': 'Restore',
        'deleted_events': 'Deleted events',
        'deleted_teams': 'Deleted teams',
        'deleted_players': 'Deleted players',
        'delete': 'Delete',
        'restore_all': 'Restore all',
        'confirm_delete_all': 'Permanently delete ALL events and empty trash?',
        'confirm_delete_event': 'Delete this event? It will be moved to trash.',
        'confirm_empty_trash': 'Permanently empty the trash?',
        // Popup
        'week_popup': 'Week',
        'sessions_popup': 'Number of sessions:',
        'minutes_popup': 'Time:',
        // Presences
        'presences': 'Presences:',
        'present_teams': 'Present teams:',
        'present_players': 'Present players:',
        'comment': 'Comment:',
      },
      es: {
        'Thème visuel :': 'Tema visual:',
        'Système': 'Sistema',
        'Clair': 'Claro',
        'Sombre': 'Oscuro',
        'Noir OLED': 'Negro OLED',
        "Inverser l'ordre de la Timeline": "Invertir el orden de la línea de tiempo",
        'Export / Import des données :': 'Exportar / Importar datos:',
        'Exporter': 'Exportar',
        'Importer': 'Importar',
        'Remplacer': 'Reemplazar',
        'Fusionner': 'Fusionar',
        'Langue :': 'Idioma:',
        'Français': 'Francés',
        'English': 'Inglés',
        'Español': 'Español',
        'Exemple de JSON :': 'Ejemplo de JSON:',
        'Copier': 'Copiar',
        'Copié !': '¡Copiado!',
        'Tout supprimer': 'Eliminar todo',
        "Erreur lors de l'import : ": 'Error al importar: ',
        'Remplacer toutes les données existantes par celles du fichier ?': '¿Reemplazar todos los datos existentes por el contenido del archivo?',
        // Interface générale
        'timeline_title': 'Línea de tiempo',
        'teams_title': 'Equipos',
        'players_title': 'Jugadores',
        'settings_title': 'Ajustes',
        'add_event': 'Agregar evento',
        'add_team': 'Agregar equipo',
        'add_player': 'Agregar jugador',
        'event_modal_title': 'Nuevo evento',
        'event_date': 'Fecha:',
        'event_date_end': 'Fecha de fin (opcional):',
        'event_start_time': 'Hora de inicio:',
        'event_end_time': 'Hora de fin:',
        'event_description': 'Descripción:',
        'event_championnat_type': 'Tipo:',
        'event_categorie': 'Categoría:',
        'event_description_autre': 'Otra descripción:',
        'event_equipes': 'Equipos invitados:',
        'add_players_case': 'Agregar jugadores individualmente',
        'event_players_invited': 'Jugadores invitados:',
        'event_recurrence': 'Recurrencia:',
        'event_recurrence_enddate': 'Fecha de fin de recurrencia:',
        'event_lieu': 'Lugar (opcional):',
        'cancel': 'Cancelar',
        'save': 'Guardar',
        'player_modal_title': 'Nuevo jugador',
        'player_name': 'Nombre o apodo*:',
        'player_birth': 'Fecha de nacimiento:',
        'player_phone': 'Teléfono:',
        'player_email': 'Correo electrónico:',
        'player_teams': 'Equipo(s) asignado(s):',
        'desc_sousleau': "Bajo el agua",
        'desc_video': "Sesión de vídeo",
        'desc_course': "Carrera",
        'desc_renfo': "Refuerzo",
        'desc_stage': "Stage",
        'desc_tournois': "Torneo",
        'desc_championnat': "Campeonato",
        'desc_autre': "Otro...",
        'timeline_view_mode': "Modo de vista de la línea de tiempo:",
        'timeline_view_compact': "Vista compacta",
        'timeline_view_detailed': "Vista detallada",
        'timeline_view_split': "Vista mixta (compacta + detallada)",
        // --- TEXTOS NUEVOS ---
        'total_presences': 'Presencias totales:',
        'total_time': 'Tiempo total:',
        'season_presences': 'Presencias esta temporada:',
        'season_time': 'Tiempo esta temporada:',
        'weekly_stats': 'Presencias/tiempo por semana:',
        'season_history': 'Historial por temporada:',
        'edit': 'Modificar',
        'back': 'Volver',
        'teams': 'Equipos:',
        'players': 'Jugadores:',
        'no_data': 'Sin datos',
        'week': 'Semana',
        'sessions_count': 'Número de sesiones:',
        'minutes': 'Tiempo:',
        // Papelera y acciones
        'trash_empty': 'Papelera vacía.',
        'empty_trash': 'Vaciar papelera',
        'restore': 'Restaurar',
        'deleted_events': 'Eventos eliminados',
        'deleted_teams': 'Equipos eliminados',
        'deleted_players': 'Jugadores eliminados',
        'delete': 'Eliminar',
        'restore_all': 'Restaurar todo',
        'confirm_delete_all': '¿Eliminar definitivamente TODOS los eventos y vaciar la papelera?',
        'confirm_delete_event': '¿Eliminar este evento? Se moverá a la papelera.',
        'confirm_empty_trash': '¿Vaciar definitivamente la papelera?',
        // Popup
        'week_popup': 'Semana',
        'sessions_popup': 'Número de sesiones:',
        'minutes_popup': 'Tiempo:',
        // Presencias
        'presences': 'Presencias:',
        'present_teams': 'Equipos presentes:',
        'present_players': 'Jugadores presentes:',
        'comment': 'Comentario:',
      },
    };
    // Ajout des clés dynamiques dans translations
    translations.fr.no_event = "Aucun événement pour l'instant.";
    translations.en.no_event = "No event yet.";
    translations.es.no_event = "Ningún evento por ahora.";
    translations.fr.no_player = "Aucun joueur enregistré.";
    translations.en.no_player = "No player registered.";
    translations.es.no_player = "Ningún jugador registrado.";
    translations.fr.no_team = "Aucune équipe enregistrée.";
    translations.en.no_team = "No team registered.";
    translations.es.no_team = "Ningún equipo registrado.";
    translations.fr.trash_empty = "Corbeille vide.";
    translations.en.trash_empty = "Trash empty.";
    translations.es.trash_empty = "Papelera vacía.";
    
    // Appliquer le thème dès le début, avant tout affichage
    (function(){
      const t = localStorage.getItem('theme') || 'system';
      document.documentElement.setAttribute('data-theme', t === 'system' ? '' : t);
    })();
  </script>
  <main>
    <!-- Timeline -->
    <section id="tab-timeline" class="tab active">
      <h2 data-i18n="timeline_title">Timeline</h2>
      <div id="timeline-content">
        <!-- Barre temporelle et cartes d'événements ici -->
      </div>
      <button class="add-btn" id="add-event-btn" title="Ajouter un événement" data-i18n-title="add_event">+</button>
    </section>
    <!-- Modal création événement -->
    <div id="event-modal" class="modal" style="display:none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <h3 data-i18n="event_modal_title">Nouvel événement</h3>
        <form id="event-form">
          <label data-i18n="event_date">Date :</label><br>
            <input type="date" name="date" id="event-date" required>
          <label data-i18n="event_date_end">Date fin (optionnel) :</label><br>
            <input type="date" name="dateEnd" id="event-date-end">
          <label data-i18n="event_start_time">Heure de début :</label><br>
            <input type="time" name="startTime" id="event-start-time" required>
          <label data-i18n="event_end_time">Heure de fin :</label><br>
            <input type="time" name="endTime" id="event-end-time">
          <label data-i18n="event_description">Description :</label><br>
            <select name="descriptionType" id="event-description-type" required>
              <option value="Sous l'eau">Sous l'eau</option>
              <option value="Séance vidéo">Séance vidéo</option>
              <option value="Course">Course</option>
              <option value="Renfo">Renfo</option>
              <option value="Stage">Stage</option>
              <option value="Tournois">Tournois</option>
              <option value="Championnat">Championnat</option>
              <option value="autre">Autre…</option>
            </select>
          <div id="event-championnat-type-container" style="display:none;">
            <label data-i18n="event_championnat_type">Type :</label><br>
              <select name="championnatType" id="event-championnat-type">
                <option value="Régionale">Régionale</option>
                <option value="Nationale">Nationale</option>
                <option value="Internationale">Internationale</option>
              </select>
            </label>
          </div>
          <div id="event-categorie-container" style="display:none;">
            <label data-i18n="event_categorie">Catégorie :</label><br>
              <select name="categorie" id="event-categorie">
                <option value="Benjamin/Cadet">Benjamin/Cadet</option>
                <option value="Minime/Junior">Minime/Junior</option>
                <option value="Adulte Mixt">Adulte Mixt</option>
                <option value="Masculin">Masculin</option>
                <option value="Féminin">Féminin</option>
              </select>
            </label>
          </div>
          <div id="event-description-autre-container" style="display:none;">
            <label data-i18n="event_description_autre">Autre description :</label><br>
              <input type="text" name="descriptionAutre" id="event-description-autre" maxlength="100">
            </label>
          </div>
          <label data-i18n="event_equipes">Équipes conviées :</label><br>
            <div id="event-equipes-checkboxes"></div>
          </label>
          <div style="margin-bottom:8px;">
            <button type="button" id="add-players-btn" data-i18n="add_players_case">Ajouter des joueurs au cas par cas</button>
          </div>
          <div id="event-players-checkboxes" style="display:none; margin-bottom:8px;">
            <strong data-i18n="event_players_invited">Joueurs invités :</strong><br>
            <label><input type="checkbox" name="players" value="Alice"> Alice</label><br>
            <label><input type="checkbox" name="players" value="Bob"> Bob</label><br>
            <label><input type="checkbox" name="players" value="Charlie"> Charlie</label><br>
          </div>
          <label data-i18n="event_recurrence">Récurrence :</label><br>
            <select name="recurrence" id="event-recurrence-select">
              <option value="none">Aucune</option>
              <option value="weekly">Chaque semaine</option>
              <option value="biweekly">Toutes les 2 semaines</option>
            </select>
            <input type="number" name="recurrenceCount" id="event-recurrence-count" min="1" max="52" placeholder="Nb d'occurrences" style="width:120px; display:none;">
          </label>
          <div id="event-recurrence-enddate-container" style="display:none;">
            <label data-i18n="event_recurrence_enddate">Date de fin de récurrence :</label><br>
              <input type="date" name="recurrenceEndDate" id="event-recurrence-enddate">
            </label>
          </div>
          <label data-i18n="event_lieu">Lieu (optionnel) :</label><br>
            <input type="text" name="lieu" id="event-lieu" maxlength="100">
          </label><br>
          <div style="margin-top:16px; text-align:right;">
            <button type="button" id="delete-event-btn-form" style="float:left;background:#e53935;display:none;">Supprimer</button>
            <button type="button" id="cancel-event-btn" data-i18n="cancel">Annuler</button>
            <button type="submit" data-i18n="save">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Teams -->
    <section id="tab-teams" class="tab">
      <h2 data-i18n="teams_title">Équipes</h2>
      <div id="teams-list">
        <!-- Liste des équipes -->
      </div>
      <div id="team-details" style="display:none;"></div>
      <button class="add-btn" id="add-team-btn" title="Ajouter une équipe" style="display:none;" data-i18n-title="add_team">+</button>
    </section>
    <!-- Players -->
    <section id="tab-players" class="tab">
      <h2 data-i18n="players_title">Joueurs</h2>
      <div id="players-list">
        <!-- Liste des joueurs -->
      </div>
      <div id="player-details" style="display:none;"></div>
      <button class="add-btn" id="add-player-btn" title="Ajouter un joueur" style="display:none;" data-i18n-title="add_player">+</button>
    </section>
    <!-- Modal ajout/modif joueur -->
    <div id="player-modal" class="modal" style="display:none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <h3 id="player-modal-title" data-i18n="player_modal_title">Nouveau joueur</h3>
        <form id="player-form">
          <input type="hidden" name="playerId" id="player-id-hidden">
          <label data-i18n="player_name">Nom ou pseudo* :</label><br>
            <input type="text" name="name" id="player-name" required maxlength="40">
          <label data-i18n="player_birth">Date de naissance :</label><br>
            <input type="date" name="birth" id="player-birth">
          <label data-i18n="player_phone">Téléphone :</label><br>
            <input type="tel" name="phone" id="player-phone" maxlength="20">
          <label data-i18n="player_email">Email(s) :</label><br>
            <textarea name="email" id="player-email" rows="2" maxlength="200" placeholder="ex : alice@email.com, alice@club.fr\n(une adresse par ligne ou séparées par virgule)"></textarea>
          <label data-i18n="player_teams">Affectation équipe(s) :</label><br>
            <div id="player-teams-checkboxes">
              <ul class="checkbox-list"></ul>
            </div>
          <div style="margin-top:16px; text-align:right;">
            <button type="button" id="delete-player-btn" style="float:left;background:#e53935;display:none;">Supprimer</button>
            <button type="button" id="cancel-player-btn" data-i18n="cancel">Annuler</button>
            <button type="submit" data-i18n="save">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Settings -->
    <section id="tab-settings" class="tab">
      <h2 data-i18n="settings_title">Paramètres</h2>
      <div id="settings-content">
        <!-- Réglages, thème, import/export -->
        <div style="margin-bottom:18px;display:flex;align-items:center;gap:16px;">
          <label><strong>Thème visuel :</strong>
            <select id="theme-select">
              <option value="system">Système</option>
              <option value="light">Clair</option>
              <option value="dark">Sombre</option>
              <option value="oled">Noir OLED</option>
            </select>
          </label>
          <label style="margin-left:12px;display:flex;align-items:center;gap:6px;">
            <span><strong>Couleur secondaire :</strong></span>
            <div id="secondary-color-preset" style="display:flex;gap:4px;margin-left:4px;">
              <button type="button" class="color-preset" data-color="#1976d2" style="width:22px;height:22px;border-radius:50%;border:2px solid #ccc;background:#1976d2;cursor:pointer;"></button>
              <button type="button" class="color-preset" data-color="#d32f2f" style="width:22px;height:22px;border-radius:50%;border:2px solid #ccc;background:#d32f2f;cursor:pointer;"></button>
              <button type="button" class="color-preset" data-color="#388e3c" style="width:22px;height:22px;border-radius:50%;border:2px solid #ccc;background:#388e3c;cursor:pointer;"></button>
              <button type="button" class="color-preset" data-color="#fbc02d" style="width:22px;height:22px;border-radius:50%;border:2px solid #ccc;background:#fbc02d;cursor:pointer;"></button>
              <button type="button" class="color-preset" data-color="#7b1fa2" style="width:22px;height:22px;border-radius:50%;border:2px solid #ccc;background:#7b1fa2;cursor:pointer;"></button>
            </div>
            <input type="color" id="secondary-color-picker" style="margin-left:6px;width:28px;height:28px;border:none;background:none;cursor:pointer;">
          </label>
        </div>
        <div style="margin-bottom:18px;" id="timeline-order-container">
          <label style="display:flex;align-items:center;"><input type="checkbox" id="timeline-order-checkbox" style="margin-right:8px;"> Inverser l'ordre de la Timeline</label>
        </div>
        <div style="margin-bottom:18px;">
          <strong>Export / Import des données :</strong><br>
          <button id="export-json-btn">Exporter</button>
          <input type="file" id="import-json-input" accept="application/json" style="display:none;">
          <button id="import-json-btn">Importer</button>
          <label style="margin-left:10px;"><input type="radio" name="import-mode" value="replace" checked> Remplacer</label>
          <label><input type="radio" name="import-mode" value="merge"> Fusionner</label>
        </div>
        <div style="margin-bottom:18px;">
          <label><strong>Langue :</strong>
            <select id="lang-select">
              <option value="fr">Français</option>
              <option value="en">English</option>
              <option value="es">Español</option>
            </select>
          </label>
        </div>
        <div style="margin-bottom:18px;">
          <label><strong>Exemple de JSON :</strong></label>
          <pre id="json-example" style="background:#222;color:#fff;padding:8px;border-radius:6px;overflow-x:auto;font-size:13px;">{
  "players": [
    {"id": "p1", "name": "Alice", "birth": "2005-03-15", "phone": "06.12.34.56.78", "email": "alice.dupont@email.com", "teams": ["e1"]},
    {"id": "p2", "name": "Bob", "birth": "2003-11-22", "phone": "07.98.76.54.32", "email": "bob.martin@email.com, bob.martin@club.fr", "teams": ["e1","e2"]},
    {"id": "p3", "name": "Charlie", "teams": ["e3"]}
  ],
  "teams": [
    {"id": "e1", "name": "Minimes", "players": ["p1","p2"]},
    {"id": "e2", "name": "Juniors", "players": ["p2"]},
    {"id": "e3", "name": "Seniors", "players": ["p3"]}
  ],
  "events": [
    {
      "id": "ev1",
      "date": "2024-06-10",
      "startTime": "18:00",
      "endTime": "20:00",
      "description": "Entraînement Minimes/Juniors",
      "location": "Gymnase A",
      "teams": ["e1", "e2"],
      "players": ["p1", "p2"],
      "presence": {"p1": true, "p2": false},
      "comment": "Prévoir les maillots."
    }
  ]
}</pre>
          <button id="copy-json-example" style="margin-top:4px;">Copier</button>
        </div>
        <div style="margin-bottom:18px;">
          <label data-i18n="timeline_view_mode"><strong>Affichage de la Timeline :</strong></label><br>
          <label><input type="radio" name="timeline-view-mode" value="compact" id="timeline-view-compact"> <span data-i18n="timeline_view_compact">Vue compacte</span></label>
          <label><input type="radio" name="timeline-view-mode" value="detailed" id="timeline-view-detailed"> <span data-i18n="timeline_view_detailed">Vue détaillée</span></label>
          <label><input type="radio" name="timeline-view-mode" value="split" id="timeline-view-split"> <span data-i18n="timeline_view_split">Vue mixte (compacte + détaillée)</span></label>
        </div>
        <button id="delete-all-btn" style="background:#e53935;margin-bottom:16px;">Tout supprimer</button>
      </div>
      <!-- Corbeille dans Paramètres -->
      <div id="trash-section" style="display:none; margin-top:24px;">
        <h3>Corbeille</h3>
        <button id="restore-all-btn" style="background:#1976d2;color:#fff;margin-bottom:10px;">Tout restaurer</button>
        <div id="trash-list"></div>
        <button id="empty-trash-btn" style="margin-top:10px;background:#e53935;">Vider la corbeille</button>
      </div>
    </section>
    <!-- Modal édition présence événement -->
    <div id="presence-modal" class="modal" style="display:none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <h3>Présences & Commentaire</h3>
        <form id="presence-form">
          <div id="presence-equipes-container"></div>
          <div id="presence-joueurs-container" style="margin-top:10px;"></div>
          <label style="margin-top:10px;display:block;">Commentaire :<br>
            <textarea name="commentaire" id="presence-commentaire" rows="2" style="width:100%;resize:vertical;"></textarea>
          </label>
          <div style="margin-top:16px; text-align:right;">
            <button type="button" id="delete-event-btn" style="float:left;background:#e53935;">Supprimer</button>
            <button type="button" id="edit-event-btn" style="margin-top:10px;float:left;background:#1976d2;color:#fff;">Modifier l'évènement</button>
            <button type="button" id="cancel-presence-btn">Annuler</button>
            <button type="submit">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Modal ajout/modif équipe -->
    <div id="team-modal" class="modal" style="display:none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <h3 id="team-modal-title">Nouvelle équipe</h3>
        <form id="team-form">
          <input type="hidden" name="teamId" id="team-id-hidden">
          <label>Nom de l'équipe* :<br>
            <input type="text" name="name" id="team-name" required maxlength="40">
          </label><br>
          <label>Joueurs affectés :<br>
            <div id="team-players-checkboxes">
              <ul class="checkbox-list" id="team-players-list"></ul>
            </div>
          </label>
          <div style="margin-top:16px; text-align:right;">
            <button type="button" id="delete-team-btn" style="float:left;background:#e53935;display:none;">Supprimer</button>
            <button type="button" id="cancel-team-btn">Annuler</button>
            <button type="submit">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <nav class="bottom-nav">
     <button class="nav-btn active" data-tab="timeline"><span><svg style="height:1.5em;width:auto;vertical-align:middle;fill:currentColor;"><use xlink:href="#icon-calendar"></use></svg></span></button>
     <button class="nav-btn" data-tab="teams"><span><svg style="height:1.5em;width:auto;vertical-align:middle;fill:currentColor;"><use xlink:href="#icon-teams"></use></svg></span></button>
     <button class="nav-btn" data-tab="players"><span><svg style="height:1.5em;width:auto;vertical-align:middle;fill:currentColor;"><use xlink:href="#icon-players"></use></svg></span></button>
     <button class="nav-btn" data-tab="settings"><span><svg style="height:1.5em;width:auto;vertical-align:middle;fill:currentColor;"><use xlink:href="#icon-settings"></use></svg></span></button>
  </nav>
  <script>
    // Navigation SPA simple
    const tabs = document.querySelectorAll('.tab');
    const navBtns = document.querySelectorAll('.nav-btn');
    const addBtns = {
      timeline: document.getElementById('add-event-btn'),
      teams: document.getElementById('add-team-btn'),
      players: document.getElementById('add-player-btn')
    };
    navBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        navBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabs.forEach(tab => tab.classList.remove('active'));
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        // Affiche le bon bouton +
        Object.keys(addBtns).forEach(key => {
          addBtns[key].style.display = (btn.dataset.tab === key) ? 'block' : 'none';
        });
        // Rafraîchir la liste des joueurs si on va sur l'onglet joueurs
        if(btn.dataset.tab === 'players') renderPlayersList();
        if(btn.dataset.tab === 'teams') renderTeamsList();
      });
    });
    // Modal événement
    const eventModal = document.getElementById('event-modal');
    const addEventBtn = document.getElementById('add-event-btn');
    const cancelEventBtn = document.getElementById('cancel-event-btn');
    // Pré-remplissage date et heures par défaut
    function pad2(n) { return n < 10 ? '0'+n : n; }
    function setDefaultDateTime() {
      const now = new Date();
      const dateStr = now.getFullYear() + '-' + pad2(now.getMonth()+1) + '-' + pad2(now.getDate());
      document.getElementById('event-date').value = dateStr;
      // Heure de début = maintenant, fin = +1h
      const h = now.getHours(), m = now.getMinutes();
      document.getElementById('event-start-time').value = pad2(h) + ':' + pad2(m);
      let h2 = h+1;
      if(h2 > 23) h2 = 23;
      document.getElementById('event-end-time').value = pad2(h2) + ':' + pad2(m);
    }
    addEventBtn.addEventListener('click', () => {
      eventModal.style.display = 'flex';
      setDefaultDateTime();
      renderEventFormTeamsAndPlayers();
      // Réinitialise les champs dynamiques
      document.getElementById('event-description-type').value = "Sous l'eau";
      document.getElementById('event-championnat-type-container').style.display = 'none';
      document.getElementById('event-categorie-container').style.display = 'none';
      document.getElementById('event-description-autre-container').style.display = 'none';
      document.getElementById('event-players-checkboxes').style.display = 'none';
      document.getElementById('event-recurrence-count').style.display = 'none';
      document.getElementById('event-recurrence-enddate-container').style.display = 'none';
      // Supprime le champ caché eventId s'il existe (pour forcer la création d'un nouvel événement)
      const idInput = document.getElementById('event-id-hidden');
      if(idInput) idInput.remove();
    });
    cancelEventBtn.addEventListener('click', () => {
      eventModal.style.display = 'none';
    });
    // Fermer le modal si clic sur le backdrop
    eventModal.querySelector('.modal-backdrop').addEventListener('click', () => {
      eventModal.style.display = 'none';
    });
    // Description dynamique
    const descType = document.getElementById('event-description-type');
    descType.addEventListener('change', function() {
      const val = this.value;
      document.getElementById('event-championnat-type-container').style.display = (val === 'Championnat' || val === 'Tournois') ? 'block' : 'none';
      document.getElementById('event-categorie-container').style.display = (val === 'Championnat' || val === 'Tournois') ? 'block' : 'none';
      document.getElementById('event-description-autre-container').style.display = (val === 'autre') ? 'block' : 'none';
    });
    // Bouton ajouter des joueurs
    document.getElementById('add-players-btn').addEventListener('click', function() {
      const box = document.getElementById('event-players-checkboxes');
      box.style.display = (box.style.display === 'none') ? 'block' : 'none';
    });
    // Récurrence dynamique
    const recurrenceSelect = document.getElementById('event-recurrence-select');
    const recurrenceCount = document.getElementById('event-recurrence-count');
    const recurrenceEndDate = document.getElementById('event-recurrence-enddate');
    const recurrenceEndDateContainer = document.getElementById('event-recurrence-enddate-container');
    let lastRecurrenceEdit = null; // 'count' ou 'date'
    recurrenceSelect.addEventListener('change', function() {
      if(this.value === 'none') {
        recurrenceCount.style.display = 'none';
        recurrenceEndDateContainer.style.display = 'none';
      } else {
        recurrenceCount.style.display = 'inline-block';
        recurrenceEndDateContainer.style.display = 'block';
      }
    });
    // --- Synchronisation entre nb d'occurrences et date de fin ---
    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }
    function getRecurrenceStep() {
      const val = recurrenceSelect.value;
      if(val === 'weekly') return 7;
      if(val === 'biweekly') return 14;
      return 0;
    }
    // Quand on modifie le nombre d'occurrences
    recurrenceCount.addEventListener('input', function() {
      if(!recurrenceCount.value || !document.getElementById('event-date').value) return;
      lastRecurrenceEdit = 'count';
      const startDate = new Date(document.getElementById('event-date').value);
      const step = getRecurrenceStep();
      let n = parseInt(recurrenceCount.value);
      if(isNaN(n) || n < 1) return;
      if(step === 0) return;
      let lastDate = new Date(startDate);
      lastDate.setDate(startDate.getDate() + step * (n-1));
      recurrenceEndDate.value = lastDate.toISOString().slice(0,10);
    });
    // Quand on modifie la date de fin
    recurrenceEndDate.addEventListener('input', function() {
      if(!recurrenceEndDate.value || !document.getElementById('event-date').value) return;
      lastRecurrenceEdit = 'date';
      const startDate = new Date(document.getElementById('event-date').value);
      const endDate = new Date(recurrenceEndDate.value);
      const step = getRecurrenceStep();
      if(step === 0) return;
      if(endDate < startDate) { recurrenceCount.value = 1; return; }
      // Calcul du nombre d'occurrences
      let n = 1;
      let d = new Date(startDate);
      while(d < endDate) {
        d.setDate(d.getDate() + step);
        if(d <= endDate) n++;
      }
      recurrenceCount.value = n;
    });
    // Si l'utilisateur modifie les deux, la dernière modif prime (déjà géré par lastRecurrenceEdit)
    // Si on change la date de début, on recalcule selon le champ modifié en dernier
    document.getElementById('event-date').addEventListener('input', function() {
      if(recurrenceSelect.value === 'none') return;
      if(lastRecurrenceEdit === 'count') {
        recurrenceCount.dispatchEvent(new Event('input'));
      } else if(lastRecurrenceEdit === 'date') {
        recurrenceEndDate.dispatchEvent(new Event('input'));
      }
    });
    // Générateur d'identifiant unique simple
    function generateEventId() {
      return 'ev_' + Date.now() + '_' + Math.floor(Math.random()*100000);
    }
    document.getElementById('event-form').addEventListener('submit', function(e) {
      e.preventDefault();
      // Construction de la description finale
      let description = '';
      const type = this.descriptionType.value;
      if(type === 'Championnat' || type === 'Tournois') {
        description = type + ' ' + this.championnatType.value + ' ' + this.categorie.value;
      } else if(type === 'autre') {
        description = this.descriptionAutre.value;
      } else {
        description = type;
      }
      // Création de l'objet événement(s)
      const baseEvent = {
        date: this.date.value,
        dateEnd: this.dateEnd.value,
        startTime: this.startTime.value,
        endTime: this.endTime.value,
        description: description,
        lieu: this.lieu.value,
        equipes: [],
        players: [],
        recurrence: this.recurrence.value,
        recurrenceCount: this.recurrenceCount.value,
        recurrenceEndDate: this.recurrenceEndDate.value
      };
      // Équipes cochées
      document.querySelectorAll('#event-equipes-checkboxes input[type=checkbox][name="equipes"]:checked').forEach(cb => {
        baseEvent.equipes.push(cb.value);
      });
      // Joueurs cochés
      document.querySelectorAll('#event-players-checkboxes input[type=checkbox][name="players"]:checked').forEach(cb => {
        baseEvent.players.push(cb.value);
      });
      // Nettoyage des valeurs vides
      if(!baseEvent.dateEnd) delete baseEvent.dateEnd;
      if(!baseEvent.lieu) delete baseEvent.lieu;
      if(!baseEvent.recurrenceCount) delete baseEvent.recurrenceCount;
      if(!baseEvent.recurrenceEndDate) delete baseEvent.recurrenceEndDate;
      // Génération des occurrences si récurrence
      let eventsToAdd = [];
      const recurrence = baseEvent.recurrence;
      let count = parseInt(baseEvent.recurrenceCount) || 1;
      if(recurrence === 'none') count = 1;
      let startDate = new Date(baseEvent.date);
      let endDate = baseEvent.recurrenceEndDate ? new Date(baseEvent.recurrenceEndDate) : null;
      for(let i=0; i<count; i++) {
        let evDate = new Date(startDate);
        if(i>0) {
          if(recurrence === 'weekly') evDate.setDate(startDate.getDate() + 7*i);
          else if(recurrence === 'biweekly') evDate.setDate(startDate.getDate() + 14*i);
        }
        if(endDate && evDate > endDate) break;
        let ev = { ...baseEvent };
        ev.id = generateEventId();
        ev.date = evDate.toISOString().slice(0,10);
        eventsToAdd.push(ev);
      }
      // Sauvegarde dans localStorage
      let events = [];
      try {
        events = JSON.parse(localStorage.getItem('events') || '[]');
      } catch(e) { events = []; }
      // Si édition (eventId existe), remplacer l'événement (pas de récurrence en édition)
      if(this.eventId && this.eventId.value) {
        let foundIdx = events.findIndex(ev => ev.id === this.eventId.value);
        if(foundIdx !== -1) {
          events[foundIdx] = { ...events[foundIdx], ...baseEvent, id: events[foundIdx].id };
        }
      } else {
        events = events.concat(eventsToAdd);
      }
      localStorage.setItem('events', JSON.stringify(events));
      // Réinitialisation et fermeture
      this.reset();
      eventModal.style.display = 'none';
      renderTimeline();
    });
    // Affichage dynamique de la timeline
    function renderTimeline() {
      const container = document.getElementById('timeline-content');
      let events = [];
      try {
        events = JSON.parse(localStorage.getItem('events') || '[]');
      } catch(e) { events = []; }
      // Tri selon réglage
      const order = localStorage.getItem('timelineOrder') || 'desc';
      events.sort((a, b) => {
        if (a.date < b.date) return order === 'desc' ? 1 : -1;
        if (a.date > b.date) return order === 'desc' ? -1 : 1;
        if (a.startTime < b.startTime) return order === 'desc' ? 1 : -1;
        if (a.startTime > b.startTime) return order === 'desc' ? -1 : 1;
        return 0;
      });
      // Mode d'affichage
      const mode = getTimelineViewMode();
      // --- Vue compacte ---
      if(mode === 'compact') {
        if(events.length === 0) {
          container.innerHTML = `<p style="color:#888;text-align:center;">${translations[getLang()]['no_event']||'Aucun événement pour l\'instant.'}</p>`;
          return;
        }
        container.innerHTML = '';
        events.forEach((ev) => {
          const div = document.createElement('div');
          div.className = 'event-card timeline-compact';
          div.style = 'background:#fff;border-radius:10px;padding:12px 10px;margin-bottom:14px;box-shadow:0 2px 8px #0001;cursor:pointer;display:flex;align-items:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:32px;';
          let html = `<strong>${ev.date}</strong> <span style='margin-left:10px;'>${ev.description}</span>`;
          // Ajout du commentaire s'il existe
          if(ev.commentaire && ev.commentaire.trim()) {
            html += ` <span style='color:#888;font-style:italic;margin-left:10px;'>📝 ${ev.commentaire}</span>`;
          }
          // Ajout des personnes présentes (équipes + joueurs)
          let presents = [];
          if(ev.equipesPresents && ev.equipesPresents.length) presents = presents.concat(ev.equipesPresents);
          if(ev.joueursPresents && ev.joueursPresents.length) presents = presents.concat(ev.joueursPresents);
          if(presents.length) {
            html += ` <span style='color:var(--secondary,#1976d2);margin-left:10px;'>| ${presents.join(', ')}</span>`;
          }
          div.innerHTML = html;
          div.setAttribute('data-event-id', ev.id);
          div.onclick = function() {
            // Ouvre la fiche détaillée (modale actuelle)
            let e = new Event('click');
            document.getElementById('timeline-content').dispatchEvent(e);
            // Simule le clic sur la carte (pour compatibilité)
            // (on peut améliorer ici si besoin)
            // On déclenche le code existant
            let card = div;
            while(card && !card.classList.contains('event-card')) card = card.parentElement;
            if(!card) return;
            const eventId = card.getAttribute('data-event-id');
            let events = [];
            try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
            const ev = events.find(ev => ev.id === eventId);
            if(!ev) return;
            currentEditEventId = eventId;
            // Affiche la modale de présence comme avant
            document.querySelector('#presence-modal h3').innerText = `${translations[getLang()]['presences']||'Présences'} & ${translations[getLang()]['comment']||'Commentaire'} — ` + (ev.description || '');
            // ... (le reste du code existant pour ouvrir la modale)
            // On réutilise le code existant
            document.getElementById('timeline-content').parentElement.querySelectorAll('.event-card').forEach(c => c.classList.remove('selected'));
            div.classList.add('selected');
            // Appel du code existant pour ouvrir la modale
            document.getElementById('timeline-content').dispatchEvent(new CustomEvent('eventcardclick', {detail: {eventId}}));
            // --- Ajout : scroll automatique vers la modale de présence ---
            setTimeout(() => {
              const modal = document.getElementById('presence-modal');
              const content = modal ? modal.querySelector('.modal-content') : null;
              if(content && modal.style.display !== 'none') {
                content.scrollIntoView({behavior:'smooth', block:'center'});
              }
            }, 100);
          };
          container.appendChild(div);
        });
        return;
      }
      // --- Vue détaillée ---
      if(mode === 'detailed') {
        if(events.length === 0) {
          container.innerHTML = `<p style="color:#888;text-align:center;">${translations[getLang()]['no_event']||'Aucun événement pour l\'instant.'}</p>`;
          return;
        }
        container.innerHTML = '';
        events.forEach((ev) => {
          const div = document.createElement('div');
          div.className = 'event-card timeline-detailed';
          div.style = 'background:#fff;border-radius:10px;padding:16px 12px;margin-bottom:18px;box-shadow:0 2px 8px #0002;position:relative;';
          let html = `<strong>${ev.date}`;
          if(ev.dateEnd) html += ` → ${ev.dateEnd}`;
          html += `</strong> | <span>${ev.startTime} - ${ev.endTime}</span><br>`;
          // Utilise la traduction dynamique pour la description si possible
          let descKey = Object.keys(translations[getLang()]).find(k => translations['fr'][k] === ev.description);
          let desc = descKey ? translations[getLang()][descKey] : ev.description;
          html += `<span style="font-size:1.1em;font-weight:bold;">${desc}</span>`;
          if(ev.lieu) html += ` <span style="color:#1976d2;">📍${ev.lieu}</span>`;
          html += '<br>';
          if(ev.equipes && ev.equipes.length)
            html += `<span style="color:#555;">${translations[getLang()]['event_equipes']||'Équipes conviées :'} ${ev.equipes.join(', ')}</span><br>`;
          if(ev.players && ev.players.length)
            html += `<span style="color:#555;">${translations[getLang()]['event_players_invited']||'Joueurs conviés :'} ${ev.players.join(', ')}</span><br>`;
          if(ev.equipesPresents && ev.equipesPresents.length)
            html += `<span style="color:#1976d2;">${translations[getLang()]['present_teams']||'Équipes présentes :'} ${ev.equipesPresents.join(', ')}</span><br>`;
          if(ev.joueursPresents && ev.joueursPresents.length)
            html += `<span style="color:#1976d2;">${translations[getLang()]['present_players']||'Joueurs présents :'} ${ev.joueursPresents.join(', ')}</span><br>`;
          if(ev.commentaire)
            html += `<span style="color:#888;font-style:italic;">📝 ${ev.commentaire}</span><br>`;
          // Présences inline (checkboxes)
          html += `<div style='margin-top:8px;'>`;
          html += `<strong>${translations[getLang()]['presences']||'Présences :'} </strong><br>`;
          // Équipes présentes
          let allEquipes = [];
          try { allEquipes = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
          allEquipes.sort((a, b) => (b.players?.length||0) - (a.players?.length||0));
          html += `<span style="font-size:0.95em;">${translations[getLang()]['teams']||'Équipes :'} `;
          html += allEquipes.map(team => {
            const checked = (ev.equipesPresents||[]).includes(team.name);
            return `<label style='margin-right:8px;'><input type='checkbox' data-ev='${ev.id}' data-type='eq' value='${team.name}' data-team-id='${team.id}' ${checked?'checked':''}>${team.name}</label>`;
          }).join('');
          html += '</span><br>';
          // Joueurs présents
          let allJoueurs = [];
          try { allJoueurs = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
          allJoueurs.sort((a, b) => (a.name||'').localeCompare(b.name||''));
          html += `<span style="font-size:0.95em;">${translations[getLang()]['players']||'Joueurs :'} `;
          html += allJoueurs.map(p => {
            const checked = (ev.joueursPresents||[]).includes(p.name);
            return `<label style='margin-right:8px;'><input type='checkbox' data-ev='${ev.id}' data-type='pl' value='${p.name}' data-player-id='${p.id}' ${checked?'checked':''}>${p.name}</label>`;
          }).join('');
          html += '</span>';
          html += '</div>';
          // Commentaire inline
          html += `<div style='margin-top:8px;'><label>${translations[getLang()]['comment']||'Commentaire :'} <input type='text' data-ev='${ev.id}' data-type='comment' value='${ev.commentaire||''}' style='width:60%;'></label></div>`;
          // Bouton modifier
          html += `<button class='edit-event-btn' data-ev='${ev.id}' style='position:absolute;top:12px;right:12px;background:#1976d2;color:#fff;border:none;border-radius:4px;padding:4px 12px;cursor:pointer;'>${translations[getLang()]['edit']||'Modifier'}</button>`;
          div.innerHTML = html;
          // Gestion inline des présences
          div.querySelectorAll('input[type=checkbox][data-ev]').forEach(cb => {
            cb.addEventListener('change', function() {
              let events = [];
              try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
              const idx = events.findIndex(ev => ev.id === cb.getAttribute('data-ev'));
              if(idx === -1) return;
              if(cb.getAttribute('data-type') === 'eq') {
                if(cb.checked) {
                  if(!events[idx].equipesPresents) events[idx].equipesPresents = [];
                  if(!events[idx].equipesPresents.includes(cb.value)) events[idx].equipesPresents.push(cb.value);
                } else {
                  if(events[idx].equipesPresents) events[idx].equipesPresents = events[idx].equipesPresents.filter(n => n !== cb.value);
                }
              } else if(cb.getAttribute('data-type') === 'pl') {
                if(cb.checked) {
                  if(!events[idx].joueursPresents) events[idx].joueursPresents = [];
                  if(!events[idx].joueursPresents.includes(cb.value)) events[idx].joueursPresents.push(cb.value);
                } else {
                  if(events[idx].joueursPresents) events[idx].joueursPresents = events[idx].joueursPresents.filter(n => n !== cb.value);
                }
              }
              localStorage.setItem('events', JSON.stringify(events));
              // SUPPRIME : renderTimeline() et restauration du scroll
            });
          });
          // --- Synchronisation équipe <-> joueurs (vue détaillée) ---
          // Map équipeId -> [playerId...]
          let teamMap = {};
          allEquipes.forEach(team => { teamMap[team.id] = team.players || []; });
          // Quand on coche une équipe, coche/décoche ses joueurs
          div.querySelectorAll('input[type=checkbox][data-type="eq"]').forEach(eqCb => {
            eqCb.addEventListener('change', function() {
              const teamId = this.getAttribute('data-team-id');
              const checked = this.checked;
              const playerIds = teamMap[teamId] || [];
              div.querySelectorAll('input[type=checkbox][data-type="pl"]').forEach(jcb => {
                if(playerIds.includes(jcb.getAttribute('data-player-id'))) {
                  jcb.checked = checked;
                  // Déclenche l'événement change pour mettre à jour la présence
                  jcb.dispatchEvent(new Event('change'));
                }
              });
            });
          });
          // Quand on coche/décoche un joueur, met à jour toutes les équipes dont il fait partie
          div.querySelectorAll('input[type=checkbox][data-type="pl"]').forEach(jCb => {
            jCb.addEventListener('change', function() {
              const playerId = this.getAttribute('data-player-id');
              allEquipes.forEach(team => {
                if((team.players||[]).includes(playerId)) {
                  const teamCb = div.querySelector(`input[type=checkbox][data-type="eq"][data-team-id="${team.id}"]`);
                  if(!teamCb) return;
                  // Tous les joueurs de l'équipe sont-ils cochés ?
                  const allChecked = (team.players||[]).every(pid => {
                    const cb = div.querySelector(`input[type=checkbox][data-type="pl"][data-player-id="${pid}"]`);
                    return cb && cb.checked;
                  });
                  teamCb.checked = allChecked;
                  // Si on décoche un joueur, décoche l'équipe correspondante
                  if(!this.checked) teamCb.checked = false;
                }
              });
            });
          });
          // Gestion inline du commentaire
          div.querySelectorAll('input[type=text][data-ev][data-type=comment]').forEach(input => {
            input.addEventListener('change', function() {
              let events = [];
              try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
              const idx = events.findIndex(ev => ev.id === input.getAttribute('data-ev'));
              if(idx === -1) return;
              events[idx].commentaire = input.value;
              localStorage.setItem('events', JSON.stringify(events));
            });
          });
          // Bouton modifier
          div.querySelector('.edit-event-btn').onclick = function() {
            openEditEventModal(ev);
          };
          container.appendChild(div);
        });
        return;
      }
      // --- Vue mixte (split) ---
      if(mode === 'split') {
        // Structure split : deux colonnes
        container.innerHTML = `<div id='timeline-split' style='display:flex;gap:2vw;'><div id='timeline-split-list' style='flex:1;min-width:180px;max-width:320px;overflow-y:auto;'></div><div id='timeline-split-detail' style='flex:2;min-width:260px;max-height:80vh;overflow-y:auto;'></div></div>`;
        const listDiv = document.getElementById('timeline-split-list');
        const detailDiv = document.getElementById('timeline-split-detail');
        if(events.length === 0) {
          listDiv.innerHTML = `<p style=\"color:#888;text-align:center;\">${translations[getLang()]['no_event']||'Aucun événement pour l\'instant.'}</p>`;
          detailDiv.innerHTML = '';
          return;
        }
        // Liste compacte à gauche
        listDiv.innerHTML = '';
        events.forEach(ev => {
          const div = document.createElement('div');
          div.className = 'event-card timeline-compact';
          div.style = 'background:#fff;border-radius:10px;padding:10px 8px;margin-bottom:10px;box-shadow:0 1px 4px #0001;cursor:pointer;display:flex;align-items:center;';
          let html = `<strong>${ev.date}</strong> <span style='margin-left:10px;'>${ev.description}</span>`;
          div.innerHTML = html;
          div.setAttribute('data-event-id', ev.id);
          div.onclick = function(e) {
            // En mode mixte, on ne déclenche que le scroll/surlignage, pas la modale de présence
            e.stopPropagation();
            const target = detailDiv.querySelector(`.event-card[data-event-id='${ev.id}']`);
            if(target) {
              target.scrollIntoView({behavior:'smooth', block:'start'});
              target.classList.add('highlighted');
              setTimeout(()=>{target.classList.remove('highlighted');}, 1200);
            }
            // Surligne la carte compacte sélectionnée
            listDiv.querySelectorAll('.event-card').forEach(c => c.classList.remove('selected'));
            div.classList.add('selected');
          };
          listDiv.appendChild(div);
        });
        // Affichage détaillé à droite : tous les événements
        detailDiv.innerHTML = '';
        events.forEach(ev => {
          let html = `<div class='event-card timeline-detailed' data-event-id='${ev.id}' style='background:#fff;border-radius:10px;padding:16px 12px;margin-bottom:18px;box-shadow:0 2px 8px #0002;position:relative;'>`;
          html += `<strong>${ev.date}`;
          if(ev.dateEnd) html += ` → ${ev.dateEnd}`;
          html += `</strong> | <span>${ev.startTime} - ${ev.endTime}</span><br>`;
          // Utilise la traduction dynamique pour la description si possible
          let descKey = Object.keys(translations[getLang()]).find(k => translations['fr'][k] === ev.description);
          let desc = descKey ? translations[getLang()][descKey] : ev.description;
          html += `<span style="font-size:1.1em;font-weight:bold;">${desc}</span>`;
          if(ev.lieu) html += ` <span style="color:#1976d2;">📍${ev.lieu}</span>`;
          html += '<br>';
          if(ev.equipes && ev.equipes.length)
            html += `<span style="color:#555;">${translations[getLang()]['event_equipes']||'Équipes conviées :'} ${ev.equipes.join(', ')}</span><br>`;
          if(ev.players && ev.players.length)
            html += `<span style="color:#555;">${translations[getLang()]['event_players_invited']||'Joueurs conviés :'} ${ev.players.join(', ')}</span><br>`;
          if(ev.equipesPresents && ev.equipesPresents.length)
            html += `<span style="color:#1976d2;">${translations[getLang()]['present_teams']||'Équipes présentes :'} ${ev.equipesPresents.join(', ')}</span><br>`;
          if(ev.joueursPresents && ev.joueursPresents.length)
            html += `<span style="color:#1976d2;">${translations[getLang()]['present_players']||'Joueurs présents :'} ${ev.joueursPresents.join(', ')}</span><br>`;
          if(ev.commentaire)
            html += `<span style="color:#888;font-style:italic;">📝 ${ev.commentaire}</span><br>`;
          // Présences inline (checkboxes)
          html += `<div style='margin-top:8px;'>`;
          html += `<strong>${translations[getLang()]['presences']||'Présences :'} </strong><br>`;
          // Équipes présentes
          let allEquipes = [];
          try { allEquipes = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
          allEquipes.sort((a, b) => (b.players?.length||0) - (a.players?.length||0));
          html += `<span style="font-size:0.95em;">${translations[getLang()]['teams']||'Équipes :'} `;
          html += allEquipes.map(team => {
            const checked = (ev.equipesPresents||[]).includes(team.name);
            return `<label style='margin-right:8px;'><input type='checkbox' data-ev='${ev.id}' data-type='eq' value='${team.name}' data-team-id='${team.id}' ${checked?'checked':''}>${team.name}</label>`;
          }).join('');
          html += '</span><br>';
          // Joueurs présents
          let allJoueurs = [];
          try { allJoueurs = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
          allJoueurs.sort((a, b) => (a.name||'').localeCompare(b.name||''));
          html += `<span style="font-size:0.95em;">${translations[getLang()]['players']||'Joueurs :'} `;
          html += allJoueurs.map(p => {
            const checked = (ev.joueursPresents||[]).includes(p.name);
            return `<label style='margin-right:8px;'><input type='checkbox' data-ev='${ev.id}' data-type='pl' value='${p.name}' data-player-id='${p.id}' ${checked?'checked':''}>${p.name}</label>`;
          }).join('');
          html += '</span>';
          html += '</div>';
          // Commentaire inline
          html += `<div style='margin-top:8px;'><label>${translations[getLang()]['comment']||'Commentaire :'} <input type='text' data-ev='${ev.id}' data-type='comment' value='${ev.commentaire||''}' style='width:60%;'></label></div>`;
          // Bouton modifier
          html += `<button class='edit-event-btn' data-ev='${ev.id}' style='position:absolute;top:12px;right:12px;background:#1976d2;color:#fff;border:none;border-radius:4px;padding:4px 12px;cursor:pointer;'>${translations[getLang()]['edit']||'Modifier'}</button>`;
          html += `</div>`;
          detailDiv.insertAdjacentHTML('beforeend', html);
        });
        // Ajout listeners inline sur toutes les cartes détaillées
        detailDiv.querySelectorAll('.event-card.timeline-detailed').forEach(card => {
          // Désactive le clic qui ouvrirait la modale de présence en mode mixte
          card.onclick = function(e) { e.stopPropagation(); };
          // Gestion inline des présences
          card.querySelectorAll('input[type=checkbox][data-ev]').forEach(cb => {
            cb.addEventListener('change', function() {
              // --- Correction scroll stable (version robuste) ---
              const scrollY = document.getElementById('timeline-split-detail')?.scrollTop || 0;
              // ---
              let events = [];
              try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
              const idx = events.findIndex(ev => ev.id === cb.getAttribute('data-ev'));
              if(idx === -1) return;
              if(cb.getAttribute('data-type') === 'eq') {
                if(cb.checked) {
                  if(!events[idx].equipesPresents) events[idx].equipesPresents = [];
                  if(!events[idx].equipesPresents.includes(cb.value)) events[idx].equipesPresents.push(cb.value);
                } else {
                  if(events[idx].equipesPresents) events[idx].equipesPresents = events[idx].equipesPresents.filter(n => n !== cb.value);
                }
              } else if(cb.getAttribute('data-type') === 'pl') {
                if(cb.checked) {
                  if(!events[idx].joueursPresents) events[idx].joueursPresents = [];
                  if(!events[idx].joueursPresents.includes(cb.value)) events[idx].joueursPresents.push(cb.value);
                } else {
                  if(events[idx].joueursPresents) events[idx].joueursPresents = events[idx].joueursPresents.filter(n => n !== cb.value);
                }
              }
              localStorage.setItem('events', JSON.stringify(events));
              // --- Restaurer le scroll sur le NOUVEL élément ---
              setTimeout(()=>{
                const newDetailDiv = document.getElementById('timeline-split-detail');
                if(newDetailDiv) newDetailDiv.scrollTop = scrollY;
              }, 0);
            });
          });
          // --- Synchronisation équipe <-> joueurs (vue split) ---
          // Map équipeId -> [playerId...]
          let allEquipes = [];
          try { allEquipes = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
          let teamMap = {};
          allEquipes.forEach(team => { teamMap[team.id] = team.players || []; });
          // Quand on coche une équipe, coche/décoche ses joueurs
          card.querySelectorAll('input[type=checkbox][data-type="eq"]').forEach(eqCb => {
            eqCb.addEventListener('change', function() {
              const teamId = this.getAttribute('data-team-id');
              const checked = this.checked;
              const playerIds = teamMap[teamId] || [];
              card.querySelectorAll('input[type=checkbox][data-type="pl"]').forEach(jcb => {
                if(playerIds.includes(jcb.getAttribute('data-player-id'))) {
                  jcb.checked = checked;
                  // Déclenche l'événement change pour mettre à jour la présence
                  jcb.dispatchEvent(new Event('change'));
                }
              });
            });
          });
          // Quand on coche/décoche un joueur, met à jour toutes les équipes dont il fait partie
          card.querySelectorAll('input[type=checkbox][data-type="pl"]').forEach(jCb => {
            jCb.addEventListener('change', function() {
              const playerId = this.getAttribute('data-player-id');
              allEquipes.forEach(team => {
                if((team.players||[]).includes(playerId)) {
                  const teamCb = card.querySelector(`input[type=checkbox][data-type="eq"][data-team-id="${team.id}"]`);
                  if(!teamCb) return;
                  // Tous les joueurs de l'équipe sont-ils cochés ?
                  const allChecked = (team.players||[]).every(pid => {
                    const cb = card.querySelector(`input[type=checkbox][data-type="pl"][data-player-id="${pid}"]`);
                    return cb && cb.checked;
                  });
                  teamCb.checked = allChecked;
                  // Si on décoche un joueur, décoche l'équipe correspondante
                  if(!this.checked) teamCb.checked = false;
                }
              });
            });
          });
          // Gestion inline du commentaire
          card.querySelectorAll('input[type=text][data-ev][data-type=comment]').forEach(input => {
            input.addEventListener('change', function() {
              let events = [];
              try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
              const idx = events.findIndex(ev => ev.id === input.getAttribute('data-ev'));
              if(idx === -1) return;
              events[idx].commentaire = input.value;
              localStorage.setItem('events', JSON.stringify(events));
            });
          });
          // Bouton modifier
          card.querySelector('.edit-event-btn').onclick = function() {
            const evId = card.getAttribute('data-event-id');
            const ev = events.find(e=>e.id===evId);
            if(ev) openEditEventModal(ev);
          };
        });
        return;
      }
    }
    // Helper pour la langue courante
    function getLang() {
      return localStorage.getItem('lang') || 'fr';
    }
    // Migration automatique : ajoute un id à tout événement qui n'en a pas
    function migrateEventsAddId() {
      let events = [];
      let changed = false;
      try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
      events.forEach(ev => {
        if(!ev.id) {
          ev.id = generateEventId();
          changed = true;
        }
      });
      if(changed) {
        localStorage.setItem('events', JSON.stringify(events));
      }
    }
    migrateEventsAddId();
    // Appel initial
    renderTimeline();
    // Rafraîchir après ajout
    document.getElementById('event-form').addEventListener('submit', function() {
      setTimeout(renderTimeline, 100); // Laisse le temps au localStorage
    });
    // Ouvre le modal de présence au clic sur un événement
    let currentEditEventId = null;
    document.getElementById('timeline-content').addEventListener('click', function(e) {
      let card = e.target;
      while(card && !card.classList.contains('event-card')) card = card.parentElement;
      if(!card) return;
      // Récupérer l'id de l'événement depuis l'attribut data-event-id
      const eventId = card.getAttribute('data-event-id');
      let events = [];
      try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
      const ev = events.find(ev => ev.id === eventId);
      if(!ev) return;
      currentEditEventId = eventId;
      // Afficher le nom de l'événement
      document.querySelector('#presence-modal h3').innerText = 'Présences & Commentaire — ' + (ev.description || '');
      // --- Affichage dynamique des équipes ---
      let allEquipes = [];
      try { allEquipes = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
      const eqDiv = document.getElementById('presence-equipes-container');
      eqDiv.innerHTML = '<strong>Équipes présentes :</strong>';
      eqDiv.innerHTML += '<ul class="checkbox-list">';
      allEquipes.forEach(team => {
        const eq = team.name;
        const checked = (ev.equipesPresents||[]).includes(eq);
        const teamId = 'team-pres-' + team.id;
        eqDiv.innerHTML += `<li class="checkbox-row">
          <label class='checkbox-label'><input type='checkbox' name='equipesPresents' value="${eq}" data-team-id="${team.id}" id="${teamId}" ${checked ? 'checked' : ''}><span class='checkbox-label-text'>${eq}</span></label>
        </li>`;
      });
      eqDiv.innerHTML += '</ul>';
      // --- Affichage dynamique des joueurs ---
      let allJoueurs = [];
      try { allJoueurs = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
      const jpDiv = document.getElementById('presence-joueurs-container');
      jpDiv.innerHTML = '<strong>Joueurs présents :</strong>';
      jpDiv.innerHTML += '<ul class="checkbox-list">';
      allJoueurs.forEach(p => {
        const j = p.name;
        const checked = (ev.joueursPresents||[]).includes(j);
        jpDiv.innerHTML += `<li class="checkbox-row">
          <label class='checkbox-label'><input type='checkbox' name='joueursPresents' value="${j}" data-player-id="${p.id}" data-player="${j}" ${checked ? 'checked' : ''}><span class='checkbox-label-text'>${j}</span></label>
        </li>`;
      });
      jpDiv.innerHTML += '</ul>';
      // Commentaire
      document.getElementById('presence-commentaire').value = ev.commentaire || '';
      document.getElementById('presence-modal').style.display = 'flex';
      // Ajout du comportement "cocher/décocher équipe <-> joueurs"
      setTimeout(() => {
        // Map équipeId -> [playerId...]
        let teamMap = {};
        allEquipes.forEach(team => { teamMap[team.id] = team.players || []; });
        // Quand on coche une équipe, coche uniquement ses joueurs (pas d'autres équipes)
        document.querySelectorAll('#presence-equipes-container input[type=checkbox][name="equipesPresents"]').forEach(eqCb => {
          eqCb.addEventListener('change', function() {
            const teamId = this.getAttribute('data-team-id');
            const checked = this.checked;
            const playerIds = teamMap[teamId] || [];
            document.querySelectorAll('#presence-joueurs-container input[type=checkbox][name="joueursPresents"]').forEach(jcb => {
              if(playerIds.includes(jcb.getAttribute('data-player-id'))) {
                jcb.checked = checked;
              }
            });
            // Ne coche/décoche aucune autre équipe ici
          });
        });
        // Quand on coche/décoche un joueur, met à jour toutes les équipes dont il fait partie
        document.querySelectorAll('#presence-joueurs-container input[type=checkbox][name="joueursPresents"]').forEach(jCb => {
          jCb.addEventListener('change', function() {
            const playerId = this.getAttribute('data-player-id');
            // Pour chaque équipe, vérifier si tous les joueurs sont cochés
            allEquipes.forEach(team => {
              if((team.players||[]).includes(playerId)) {
                const teamCb = document.querySelector(`#presence-equipes-container input[type=checkbox][data-team-id="${team.id}"]`);
                if(!teamCb) return;
                // Tous les joueurs de l'équipe sont-ils cochés ?
                const allChecked = (team.players||[]).every(pid => {
                  const cb = document.querySelector(`#presence-joueurs-container input[type=checkbox][data-player-id="${pid}"]`);
                  return cb && cb.checked;
                });
                teamCb.checked = allChecked;
                // Si on décoche un joueur, décoche l'équipe correspondante
                if(!this.checked) teamCb.checked = false;
              }
            });
          });
        });
      }, 50);
      // Préparer le bouton "Modifier l'évènement"
      const editBtn = document.getElementById('edit-event-btn');
      editBtn.onclick = function() {
        openEditEventModal(ev);
      };
    });
    // Fermer le modal présence
    document.getElementById('cancel-presence-btn').onclick = function() {
      document.getElementById('presence-modal').style.display = 'none';
    };
    document.querySelector('#presence-modal .modal-backdrop').onclick = function() {
      document.getElementById('presence-modal').style.display = 'none';
    };
    // Sauvegarde des présences/commentaire
    document.getElementById('presence-form').addEventListener('submit', function(e) {
      e.preventDefault();
      let events = [];
      try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
      if(!currentEditEventId) return;
      const idx = events.findIndex(ev => ev.id === currentEditEventId);
      if(idx === -1) return;
      const ev = events[idx];
      // Équipes présentes
      ev.equipesPresents = Array.from(document.querySelectorAll('#presence-equipes-container input[type=checkbox][name="equipesPresents"]:checked')).map(cb=>cb.value).filter(v => v && v !== 'on');
      // Joueurs présents
      ev.joueursPresents = Array.from(document.querySelectorAll('#presence-joueurs-container input[type=checkbox][name="joueursPresents"]:checked')).map(cb=>cb.value).filter(v => v && v !== 'on');
      // Commentaire
      ev.commentaire = document.getElementById('presence-commentaire').value;
      // Sauvegarde
      localStorage.setItem('events', JSON.stringify(events));
      document.getElementById('presence-modal').style.display = 'none';
      renderTimeline();
    });
    // Fonction pour ouvrir le formulaire d'édition complet pré-rempli
    function openEditEventModal(ev) {
      document.getElementById('presence-modal').style.display = 'none';
      // Pré-remplir le formulaire de création
      eventModal.style.display = 'flex';
      document.getElementById('event-date').value = ev.date || '';
      document.getElementById('event-date-end').value = ev.dateEnd || '';
      document.getElementById('event-start-time').value = ev.startTime || '';
      document.getElementById('event-end-time').value = ev.endTime || '';
      document.getElementById('event-lieu').value = ev.lieu || '';
      // Description
      let type = 'autre';
      let championnatType = '';
      let categorie = '';
      if(ev.description && ev.description.startsWith('Championnat')) {
        type = 'Championnat';
        [, , championnatType, ...categorie] = ev.description.split(/\s+/);
        categorie = categorie.join(' ');
      } else if(ev.description && ev.description.startsWith('Tournois')) {
        type = 'Tournois';
        [, , championnatType, ...categorie] = ev.description.split(/\s+/);
        categorie = categorie.join(' ');
      } else if(ev.description && ["Sous l'eau","Séance vidéo","Course","Renfo","Stage"].includes(ev.description)) {
        type = ev.description;
      } else {
        type = 'autre';
      }
      document.getElementById('event-description-type').value = type;
      document.getElementById('event-championnat-type-container').style.display = (type === 'Championnat' || type === 'Tournois') ? 'block' : 'none';
      document.getElementById('event-categorie-container').style.display = (type === 'Championnat' || type === 'Tournois') ? 'block' : 'none';
      document.getElementById('event-description-autre-container').style.display = (type === 'autre') ? 'block' : 'none';
      if(type === 'Championnat' || type === 'Tournois') {
        document.getElementById('event-championnat-type').value = championnatType || '';
        document.getElementById('event-categorie').value = categorie || '';
      }
      if(type === 'autre') {
        document.getElementById('event-description-autre').value = ev.description || '';
      }
      // Équipes
      document.querySelectorAll('#event-equipes-checkboxes input[type=checkbox]').forEach(cb => {
        cb.checked = (ev.equipes||[]).includes(cb.value);
      });
      // Joueurs
      document.querySelectorAll('#event-players-checkboxes input[type=checkbox]').forEach(cb => {
        cb.checked = (ev.players||[]).includes(cb.value);
      });
      // Récurrence
      document.getElementById('event-recurrence-select').value = ev.recurrence || 'none';
      document.getElementById('event-recurrence-count').value = ev.recurrenceCount || '';
      document.getElementById('event-recurrence-enddate').value = ev.recurrenceEndDate || '';
      document.getElementById('event-recurrence-count').style.display = (ev.recurrence && ev.recurrence !== 'none') ? 'inline-block' : 'none';
      document.getElementById('event-recurrence-enddate-container').style.display = (ev.recurrence && ev.recurrence !== 'none') ? 'block' : 'none';
      // Ajoute un champ caché pour l'id
      let idInput = document.getElementById('event-id-hidden');
      if(!idInput) {
        idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'eventId';
        idInput.id = 'event-id-hidden';
        document.getElementById('event-form').appendChild(idInput);
      }
      idInput.value = ev.id;
      // Affiche le bouton supprimer dans le formulaire (mode édition)
      const delBtn = document.getElementById('delete-event-btn-form');
      if(delBtn) delBtn.style.display = 'inline-block';
      // Ajoute le handler suppression (même logique que dans la modale de présence)
      if(delBtn) {
        delBtn.onclick = function() {
          if(!confirm('Supprimer cet événement ? Il sera placé dans la corbeille.')) return;
          let events = [];
          let trash = [];
          try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
          try { trash = JSON.parse(localStorage.getItem('events_trash') || '[]'); } catch(e){}
          if(!ev.id) return;
          // Déplacer dans la corbeille
          trash.push(events.find(e => e.id === ev.id));
          events.splice(events.findIndex(e => e.id === ev.id), 1);
          localStorage.setItem('events', JSON.stringify(events));
          localStorage.setItem('events_trash', JSON.stringify(trash));
          eventModal.style.display = 'none';
          renderTimeline();
          renderTrash();
        };
      }
    }
    // Masque le bouton supprimer en mode création
    document.getElementById('add-event-btn').addEventListener('click', () => {
      const delBtn = document.getElementById('delete-event-btn-form');
      if(delBtn) delBtn.style.display = 'none';
    });
    // Suppression d'un événement (mise en corbeille)
    document.getElementById('delete-event-btn').onclick = function() {
      if(!confirm('Supprimer cet événement ? Il sera placé dans la corbeille.')) return;
      let events = [];
      let trash = [];
      try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
      try { trash = JSON.parse(localStorage.getItem('events_trash') || '[]'); } catch(e){}
      if(!currentEditEventId) return;
      // Déplacer dans la corbeille
      trash.push(events.find(ev => ev.id === currentEditEventId));
      events.splice(events.findIndex(ev => ev.id === currentEditEventId), 1);
      localStorage.setItem('events', JSON.stringify(events));
      localStorage.setItem('events_trash', JSON.stringify(trash));
      document.getElementById('presence-modal').style.display = 'none';
      renderTimeline();
      renderTrash();
    };
    // Affichage de la corbeille
    function renderTrash() {
      const section = document.getElementById('trash-section');
      const list = document.getElementById('trash-list');
      // --- Événements supprimés ---
      let eventsTrash = [];
      try { eventsTrash = JSON.parse(localStorage.getItem('events_trash') || '[]'); } catch(e){}
      // --- Équipes supprimées ---
      let teamsTrash = [];
      try { teamsTrash = JSON.parse(localStorage.getItem('teams_trash') || '[]'); } catch(e){}
      // --- Joueurs supprimés ---
      let playersTrash = [];
      try { playersTrash = JSON.parse(localStorage.getItem('players_trash') || '[]'); } catch(e){}
      if(eventsTrash.length === 0 && teamsTrash.length === 0 && playersTrash.length === 0) {
        list.innerHTML = '<p style="color:#888;">Corbeille vide.</p>';
        return;
      }
      let html = '';
      // --- Affichage événements supprimés ---
      if(eventsTrash.length) {
        html += '<h4>Événements supprimés</h4>';
        eventsTrash.forEach((ev, i) => {
          html += `<div class='event-card' style='background:#fff;border-radius:10px;padding:10px 8px;margin-bottom:10px;box-shadow:0 1px 4px #0001;'>`;
          html += `<strong>${ev.date}`;
        if(ev.dateEnd) html += ` → ${ev.dateEnd}`;
        html += `</strong> | <span>${ev.startTime} - ${ev.endTime}</span><br>`;
        html += `<span style='font-weight:bold;'>${ev.description}</span>`;
        if(ev.lieu) html += ` <span style='color:#1976d2;'>📍${ev.lieu}</span>`;
        html += '<br>';
        if(ev.equipes && ev.equipes.length)
          html += `<span style='color:#555;'>${translations[getLang()]['event_equipes']||'Équipes conviées :'} ${ev.equipes.join(', ')}</span><br>`;
        if(ev.players && ev.players.length)
          html += `<span style='color:#555;'>${translations[getLang()]['event_players_invited']||'Joueurs conviés :'} ${ev.players.join(', ')}</span><br>`;
        if(ev.equipesPresents && ev.equipesPresents.length)
          html += `<span style="color:#1976d2;">${translations[getLang()]['present_teams']||'Équipes présentes :'} ${ev.equipesPresents.join(', ')}</span><br>`;
        if(ev.joueursPresents && ev.joueursPresents.length)
          html += `<span style="color:#1976d2;">${translations[getLang()]['present_players']||'Joueurs présents :'} ${ev.joueursPresents.join(', ')}</span><br>`;
        if(ev.commentaire)
          html += `<span style="color:#888;font-style:italic;">📝 ${ev.commentaire}</span><br>`;
          html += `<button class='restore-event-btn' data-idx='${i}' style='margin-top:6px;'>Restaurer</button>`;
          html += `</div>`;
        });
      }
      // --- Affichage équipes supprimées ---
      if(teamsTrash.length) {
        html += '<h4>Équipes supprimées</h4>';
        teamsTrash.forEach((team, i) => {
          html += `<div class='team-card' style='background:#fff;border-radius:10px;padding:10px 8px;margin-bottom:10px;box-shadow:0 1px 4px #0001;'>`;
          html += `<span style='font-weight:bold;'>${team.name}</span>`;
          if(team.players && team.players.length)
            html += ` <span style='color:#1976d2;font-size:0.95em;'>(${team.players.length} joueur${team.players.length>1?'s':''})</span>`;
          html += `<br><button class='restore-team-btn' data-idx='${i}' style='margin-top:6px;'>Restaurer</button>`;
          html += `</div>`;
        });
      }
      // --- Affichage joueurs supprimés ---
      if(playersTrash.length) {
        html += '<h4>Joueurs supprimés</h4>';
        playersTrash.forEach((player, i) => {
          html += `<div class='player-card' style='background:#fff;border-radius:10px;padding:10px 8px;margin-bottom:10px;box-shadow:0 1px 4px #0001;'>`;
          html += `<span style='font-weight:bold;'>${player.name}</span>`;
          if(player.teams && player.teams.length)
            html += ` <span style='color:#1976d2;font-size:0.95em;'>(${player.teams.join(', ')})</span>`;
          if(player.email)
            html += `<br><span style='color:#888;'>${Array.isArray(player.email) ? player.email.join(', ') : player.email}</span>`;
          html += `<br><button class='restore-player-btn' data-idx='${i}' style='margin-top:6px;'>Restaurer</button>`;
          html += `</div>`;
        });
      }
      list.innerHTML = html;
      // --- Listeners restauration ---
      list.querySelectorAll('.restore-event-btn').forEach(btn => {
        btn.onclick = function() {
          let trash = [];
          let events = [];
          try { trash = JSON.parse(localStorage.getItem('events_trash') || '[]'); } catch(e){}
          try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if(isNaN(idx) || idx < 0 || idx >= trash.length) return;
          events.push(trash[idx]);
          trash.splice(idx, 1);
          localStorage.setItem('events', JSON.stringify(events));
          localStorage.setItem('events_trash', JSON.stringify(trash));
          renderTimeline();
          renderTrash();
        };
      });
      list.querySelectorAll('.restore-team-btn').forEach(btn => {
        btn.onclick = function() {
          let trash = [];
          let teams = [];
          try { trash = JSON.parse(localStorage.getItem('teams_trash') || '[]'); } catch(e){}
          try { teams = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if(isNaN(idx) || idx < 0 || idx >= trash.length) return;
          teams.push(trash[idx]);
          trash.splice(idx, 1);
          localStorage.setItem('teams', JSON.stringify(teams));
          localStorage.setItem('teams_trash', JSON.stringify(trash));
          renderTeamsList();
          renderTrash();
        };
      });
      list.querySelectorAll('.restore-player-btn').forEach(btn => {
        btn.onclick = function() {
          let trash = [];
          let players = [];
          try { trash = JSON.parse(localStorage.getItem('players_trash') || '[]'); } catch(e){}
          try { players = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if(isNaN(idx) || idx < 0 || idx >= trash.length) return;
          players.push(trash[idx]);
          trash.splice(idx, 1);
          localStorage.setItem('players', JSON.stringify(players));
          localStorage.setItem('players_trash', JSON.stringify(trash));
          renderPlayersList();
          renderTrash();
        };
      });
    }
    // Vider la corbeille
    document.getElementById('empty-trash-btn').onclick = function() {
      if(!confirm('Vider définitivement la corbeille ?')) return;
      localStorage.setItem('events_trash', '[]');
      renderTrash();
    };
    // Affichage de la corbeille dans l'onglet paramètres
    const settingsTab = document.getElementById('tab-settings');
    const trashSection = document.getElementById('trash-section');
    document.querySelector('nav .nav-btn[data-tab="settings"]').addEventListener('click', function() {
      trashSection.style.display = 'block';
      renderTrash();
    });
    // Masquer la corbeille si on quitte l'onglet paramètres
    document.querySelectorAll('nav .nav-btn').forEach(btn => {
      if(btn.dataset.tab !== 'settings') {
        btn.addEventListener('click', function() {
          trashSection.style.display = 'none';
        });
      }
    });
    // Bouton Tout supprimer (événements + corbeille)
    document.getElementById('delete-all-btn').onclick = function() {
      if(confirm('Supprimer définitivement TOUS les événements et vider la corbeille ?')) {
        localStorage.setItem('events', '[]');
        localStorage.setItem('events_trash', '[]');
        renderTimeline();
        renderTrash();
      }
    };
    // Bouton Tout restaurer dans la corbeille
    document.getElementById('restore-all-btn').onclick = function() {
      // Restaurer tous les événements
      let eventsTrash = [];
      let events = [];
      try { eventsTrash = JSON.parse(localStorage.getItem('events_trash') || '[]'); } catch(e){}
      try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
      if(eventsTrash.length) {
        events = events.concat(eventsTrash);
      localStorage.setItem('events', JSON.stringify(events));
        localStorage.setItem('events_trash', '[]');
      renderTimeline();
      }
      // Restaurer toutes les équipes
      let teamsTrash = [];
      let teams = [];
      try { teamsTrash = JSON.parse(localStorage.getItem('teams_trash') || '[]'); } catch(e){}
      try { teams = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
      if(teamsTrash.length) {
        teams = teams.concat(teamsTrash);
        localStorage.setItem('teams', JSON.stringify(teams));
        localStorage.setItem('teams_trash', '[]');
        renderTeamsList();
      }
      // Restaurer tous les joueurs
      let playersTrash = [];
      let players = [];
      try { playersTrash = JSON.parse(localStorage.getItem('players_trash') || '[]'); } catch(e){}
      try { players = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
      if(playersTrash.length) {
        players = players.concat(playersTrash);
        localStorage.setItem('players', JSON.stringify(players));
        localStorage.setItem('players_trash', '[]');
        renderPlayersList();
      }
      renderTrash();
    };
    // Gestion joueurs
    function generatePlayerId() {
      return 'pl_' + Date.now() + '_' + Math.floor(Math.random()*100000);
    }
    function renderPlayersList() {
      const listDiv = document.getElementById('players-list');
      let players = [];
      try { players = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
      players.sort((a, b) => (a.name||'').localeCompare(b.name||''));
      if(players.length === 0) {
        listDiv.innerHTML = '<p style="color:#888;text-align:center;">Aucun joueur enregistré.</p>';
        return;
      }
      listDiv.innerHTML = '';
      players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'player-card';
        div.style = 'background:#fff;border-radius:10px;padding:10px 8px;margin-bottom:10px;box-shadow:0 1px 4px #0001;display:flex;align-items:center;cursor:pointer;';
        let html = `<span style='font-weight:bold;'>${player.name}</span>`;
        if(player.teams && player.teams.length)
          html += ` <span style='color:#1976d2;font-size:0.95em;'>(${player.teams.join(', ')})</span>`;
        div.innerHTML = html;
        div.onclick = function() { showPlayerDetails(player.id); };
        listDiv.appendChild(div);
      });
    }
    // Affiche la fiche détaillée d'un joueur
    function showPlayerDetails(playerId) {
      document.getElementById('team-details').style.display = 'none';
      let players = [];
      try { players = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
      const player = players.find(p => p.id === playerId);
      if(!player) return;
      // Calcul de l'âge
      let age = '';
      if(player.birth) {
        const birthDate = new Date(player.birth);
        const now = new Date();
        let a = now.getFullYear() - birthDate.getFullYear();
        const m = now.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && now.getDate() < birthDate.getDate())) a--;
        age = a + ' ans';
      }
      // Nombre de présences
      let events = [];
      try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
      let presences = 0;
      let weekly = {};
      let weeklyMinutes = {};
      let seasonCounts = {};
      let currentSeason = getSeasonFromDate((new Date()).toISOString().slice(0,10));
      let currentSeasonCount = 0;
      let totalMinutes = 0;
      let currentSeasonMinutes = 0;
      events.forEach(ev => {
        if(ev.joueursPresents && ev.joueursPresents.includes(player.name)) {
          presences++;
          // Semaine ISO
          const d = new Date(ev.date);
          const y = d.getFullYear();
          const week = getWeekNumber(d);
          const key = y + '-W' + week;
          weekly[key] = (weekly[key]||0) + 1;
          // --- Ajout : temps par semaine ---
          if(ev.startTime && ev.endTime) {
            const min = getDurationMinutes(ev.startTime, ev.endTime);
            weeklyMinutes[key] = (weeklyMinutes[key]||0) + min;
            totalMinutes += min;
            const season = getSeasonFromDate(ev.date);
            if(season === currentSeason) currentSeasonMinutes += min;
          }
          // Saison
          const season = getSeasonFromDate(ev.date);
          seasonCounts[season] = (seasonCounts[season]||0) + 1;
          if(season === currentSeason) currentSeasonCount++;
        }
      });
      // --- Formatage durée ---
      function formatMinutes(mins) {
        const h = Math.floor(mins/60);
        const m = mins%60;
        return (h ? (h+' h ') : '') + m + ' min';
      }
      // Générer le graphique (7 dernières semaines)
      const weeks = getLastNWeeks(7);
      const maxVal = Math.max(1, ...weeks.map(w => weekly[w]||0));
      let bars = weeks.map(w => `<div style='flex:1;margin:0 2px;display:flex;flex-direction:column;align-items:center;'><div style='height:${Math.round(40*(weekly[w]||0)/maxVal)}px;width:18px;background:#1976d2;border-radius:4px 4px 0 0;'></div><span style='font-size:0.8em;color:#888;'>${w.slice(5)}</span></div>`).join('');
      let graph = `<div style='display:flex;align-items:end;height:48px;margin:8px 0 0 0;'>${bars}</div>`;
      // Historique par saison (trié du plus récent au plus ancien)
      let seasonsSorted = Object.keys(seasonCounts).sort((a,b)=>b.localeCompare(a));
      let seasonHistory = seasonsSorted.map(s => `<div>${s} : <strong>${seasonCounts[s]}</strong></div>`).join('');
      // --- Ajout : graphique hebdomadaire enrichi (joueur et équipe) ---
      function renderWeeklyGraph(weekly, weeklyMinutes, onBarClick) {
        // Récupère toutes les semaines où il y a eu au moins 1 présence
        const allWeeks = Object.keys(weekly).concat(Object.keys(weeklyMinutes)).filter((v,i,a)=>a.indexOf(v)===i);
        allWeeks.sort();
        if(allWeeks.length === 0) return '<div style="color:#888;">Aucune donnée</div>';
        // Découpe en groupes de 7 semaines
        const graphs = [];
        for(let i=0; i<allWeeks.length; i+=7) {
          const weeks = allWeeks.slice(i, i+7);
          // Valeurs max pour l'échelle (sur toutes les semaines, pour garder la même échelle)
          const maxCount = Math.max(...allWeeks.map(w => weekly[w]||0), 1);
          const maxMinutes = Math.max(...allWeeks.map(w => weeklyMinutes[w]||0), 1);
          // Largeur du conteneur (100% de la fenêtre ou parent)
          const containerW = Math.max(320, window.innerWidth - 64);
          const barW = weeks.length > 1 ? Math.floor(containerW / weeks.length) : containerW;
          const H = 60;
          const scaleY = 5/6;
          let points = weeks.map((w,j) => {
            const x = j*barW + barW/2;
            const y = H - Math.round((weeklyMinutes[w]||0)/maxMinutes*H*scaleY);
            return `${x},${y}`;
          }).join(' ');
          let svg = `<svg width='${containerW}' height='${H+24}' style='overflow:visible;min-width:100%;'>`;
          weeks.forEach((w,j) => {
            const x = j*barW;
            const h = Math.round((weekly[w]||0)/maxCount*H*scaleY);
            svg += `<rect x='${x+Math.max(8,barW/8)}' y='${H-h}' width='${Math.max(20,barW-16)}' height='${h}' fill='#1976d2' rx='4'/>`;
            svg += `<rect class='weekly-graph-barzone' x='${x+Math.max(8,barW/8)}' y='${H-H*scaleY}' width='${Math.max(20,barW-16)}' height='${H*scaleY}' data-week='${w}' style='pointer-events:all;fill:transparent;'/>`;
          });
          svg += `<line x1='0' y1='${H}' x2='${containerW}' y2='${H}' stroke='#bbb'/>`;
          svg += `<line x1='0' y1='0' x2='0' y2='${H}' stroke='#bbb'/>`;
          weeks.forEach((w,j) => {
            const x = j*barW + barW/2;
            svg += `<text x='${x}' y='${H+14}' text-anchor='middle' font-size='10' fill='#888'>${w.slice(5)}</text>`;
          });
          svg += '</svg>';
          graphs.push(`<div style='width:100%;padding-bottom:8px;position:relative;' class='weekly-graph-container' data-weeks='${JSON.stringify(weeks)}'>
            ${svg}
            <div class='weekly-graph-popup' style='display:none;position:absolute;z-index:10;border-radius:8px;padding:6px 12px;box-shadow:0 2px 8px #0002;font-size:0.98em;'></div>
          </div>`);
        }
        // --- Ajout : interactivité du popup sur TOUS les graphes après leur insertion ---
        setTimeout(() => {
          document.querySelectorAll('.weekly-graph-container').forEach((graphDiv, idx) => {
            // Récupère les semaines de ce graphe
            let weeks = [];
            try { weeks = JSON.parse(graphDiv.getAttribute('data-weeks')); } catch(e){}
            // On reconstitue les weekly/weeklyMinutes locaux à ce graphe
            const localWeekly = {};
            const localWeeklyMinutes = {};
            weeks.forEach(w => { localWeekly[w] = weekly[w]||0; localWeeklyMinutes[w] = weeklyMinutes[w]||0; });
            const popup = graphDiv.querySelector('.weekly-graph-popup');
            Array.from(graphDiv.querySelectorAll('.weekly-graph-barzone, circle')).forEach(el => {
              el.onclick = function(e) {
                const week = this.getAttribute('data-week');
                if(!week) return;
                const n = localWeekly[week]||0;
                const t = localWeeklyMinutes[week]||0;
                popup.innerHTML = `<strong>Semaine ${week.slice(5)}</strong><br>Nombre de séances : <b>${n}</b><br>Temps : <b>${formatMinutes(t)}</b>`;
                popup.style.display = 'block';
                // Style thème (forcé)
                const root = document.documentElement;
                const card = getComputedStyle(root).getPropertyValue('--card') || '#111';
                const fg = getComputedStyle(root).getPropertyValue('--fg') || '#fff';
                const secondary = getComputedStyle(root).getPropertyValue('--secondary') || '#1976d2';
                popup.style.background = card + ' !important';
                popup.style.color = fg + ' !important';
                popup.style.border = '1px solid ' + secondary;
                popup.style.boxShadow = '0 2px 8px #0002';
                // Position popup centrée sur la barre
                const rect = this.getBoundingClientRect();
                const parentRect = graphDiv.getBoundingClientRect();
                popup.style.left = (rect.left-parentRect.left+rect.width/2-60)+'px';
                popup.style.top = (rect.top-parentRect.top-38)+'px';
              };
            });
            graphDiv.addEventListener('mouseleave', ()=>{ popup.style.display='none'; });
          });
        }, 0);
        return graphs.join('');
      }
      // Affichage fiche
      const details = document.getElementById('player-details');
      // Récupère la liste des équipes pour faire le lien nom <-> id
      let allTeams = [];
      try { allTeams = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
      // Génère les badges équipes cliquables
      let teamBadges = '';
      if(player.teams && player.teams.length) {
        teamBadges = player.teams.map(teamName => {
          const team = allTeams.find(t => t.name === teamName);
          if(team) {
            return `<span class='team-link-badge' data-team-id='${team.id}' style='display:inline-block;margin:2px 8px 2px 0;padding:2px 8px;background:#e3eafc;border-radius:8px;cursor:pointer;color:var(--secondary,#1976d2);text-decoration:underline;'>${team.name}</span>`;
          } else {
            return `<span style='color:#888;'>${teamName}</span>`;
          }
        }).join(' ');
      }
      details.innerHTML = `
        <button id='player-back-btn' style='margin-bottom:10px;'>&larr; ${translations[getLang()]['back']||'Retour'}</button>
        <h3 style='margin-top:0;'>${player.name}</h3>
        <div style='margin-bottom:8px;'>
          ${player.birth ? `${translations[getLang()]['player_birth']||'Né(e) le'} ${player.birth} ${age ? '('+age+')' : ''}<br>` : ''}
          ${player.phone ? `📞 ${player.phone}<br>` : ''}
          ${player.email ? `✉️ ${Array.isArray(player.email) ? player.email.join('<br>') : player.email.split(/, ?/).join('<br>') }<br>` : ''}
          ${teamBadges ? `<span style='color:#1976d2;'>${translations[getLang()]['teams']||'Équipes :'} ${teamBadges}</span><br>` : ''}
        </div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['total_presences']||'Présences totales :'} </strong> ${presences}</div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['total_time']||'Temps total :'} </strong> ${formatMinutes(totalMinutes)}</div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['season_presences']||'Présences cette saison :'} (${currentSeason})</strong> ${currentSeasonCount}</div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['season_time']||'Temps cette saison :'} </strong> ${formatMinutes(currentSeasonMinutes)}</div>
        <div style='margin-bottom:8px;max-width:100%;overflow-x:auto;'><strong>${translations[getLang()]['weekly_stats']||'Présences/temps par semaine :'} </strong>${renderWeeklyGraph(weekly, weeklyMinutes)}</div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['season_history']||'Historique par saison :'} </strong>${seasonHistory}</div>
        <button id='player-edit-btn' style='margin-top:10px;'>${translations[getLang()]['edit']||'Modifier'}</button>
      `;
      // Ajoute l'écouteur de clic sur chaque badge équipe
      Array.from(details.querySelectorAll('.team-link-badge')).forEach(el => {
        el.onclick = function(e) {
          const tid = this.getAttribute('data-team-id');
          if(tid) {
            // Active l'onglet équipes
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-teams').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn[data-tab="teams"]').classList.add('active');
            details.style.display = 'none';
            showTeamDetails(tid);
          }
        };
      });
      // Rends la fiche scrollable si besoin
      details.style.maxHeight = '70vh';
      details.style.overflowY = 'auto';
      // Interactivité du graphique
      const graphDiv = details.querySelector('.weekly-graph-container');
      if(graphDiv) {
        const popup = graphDiv.querySelector('.weekly-graph-popup');
        graphDiv.querySelectorAll('.weekly-graph-barzone, circle').forEach(el => {
          el.addEventListener('click', function(e) {
            const week = this.getAttribute('data-week');
            if(!week) return;
            const n = weekly[week]||0;
            const t = weeklyMinutes[week]||0;
            popup.innerHTML = `<strong>Semaine ${week.slice(5)}</strong><br>Nombre de séances : <b>${n}</b><br>Temps : <b>${formatMinutes(t)}</b>`;
            popup.style.display = 'block';
            // Style thème (forcé)
            const root = document.documentElement;
            const card = getComputedStyle(root).getPropertyValue('--card') || '#111';
            const fg = getComputedStyle(root).getPropertyValue('--fg') || '#fff';
            const secondary = getComputedStyle(root).getPropertyValue('--secondary') || '#1976d2';
            popup.style.background = card + ' !important';
            popup.style.color = fg + ' !important';
            popup.style.border = '1px solid ' + secondary;
            popup.style.boxShadow = '0 2px 8px #0002';
            // Position popup centrée sur la barre
            const rect = this.getBoundingClientRect();
            const parentRect = graphDiv.getBoundingClientRect();
            popup.style.left = (rect.left-parentRect.left+rect.width/2-60)+'px';
            popup.style.top = (rect.top-parentRect.top-38)+'px';
          });
        });
        graphDiv.addEventListener('mouseleave', ()=>{ popup.style.display='none'; });
      }
      document.getElementById('players-list').style.display = 'none';
      details.style.display = 'block';
      document.getElementById('add-player-btn').style.display = 'none';
      document.getElementById('player-back-btn').onclick = function() {
        // Si on vient d'une fiche équipe, retour à la fiche équipe
        if(window.previousTeamId) {
          // Active l'onglet équipes
          document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
          document.getElementById('tab-teams').classList.add('active');
          document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelector('.nav-btn[data-tab="teams"]').classList.add('active');
          document.getElementById('player-details').style.display = 'none';
          showTeamDetails(window.previousTeamId);
          window.previousTeamId = null;
        } else {
        details.style.display = 'none';
        document.getElementById('players-list').style.display = 'block';
        document.getElementById('add-player-btn').style.display = 'block';
        }
      };
      document.getElementById('player-edit-btn').onclick = function() {
        openPlayerModal(player.id);
      };
    }
    // Semaine ISO (helper)
    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return weekNo;
    }
    // 7 dernières semaines (helper)
    function getLastNWeeks(n) {
      const now = new Date();
      let weeks = [];
      for(let i=n-1; i>=0; i--) {
        let d = new Date(now);
        d.setDate(d.getDate() - 7*i);
        const y = d.getFullYear();
        const w = getWeekNumber(d);
        weeks.push(y+'-W'+w);
      }
      return weeks;
    }
    // --- Utilitaire : durée en minutes entre deux horaires HH:MM ---
    function getDurationMinutes(start, end) {
      if(!start || !end) return 0;
      const [h1, m1] = start.split(':').map(Number);
      const [h2, m2] = end.split(':').map(Number);
      let d = (h2*60 + m2) - (h1*60 + m1);
      if(d < 0) d += 24*60; // gestion passage minuit
      return d;
    }
    // Ouvre le modal d'ajout/modif joueur
    function openPlayerModal(playerId) {
      document.getElementById('player-details').style.display = 'none';
      document.getElementById('players-list').style.display = 'block';
      document.getElementById('add-player-btn').style.display = 'block';
      const modal = document.getElementById('player-modal');
      const form = document.getElementById('player-form');
      let player = null;
      if(playerId) {
        let players = [];
        try { players = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
        player = players.find(p => p.id === playerId);
      }
      document.getElementById('player-modal-title').innerText = player ? 'Modifier joueur' : 'Nouveau joueur';
      form.reset();
      document.getElementById('player-id-hidden').value = player ? player.id : '';
      document.getElementById('player-name').value = player ? player.name : '';
      document.getElementById('player-birth').value = player ? (player.birth || '') : '';
      document.getElementById('player-phone').value = player ? (player.phone || '') : '';
      document.getElementById('player-email').value = player ? (Array.isArray(player.email) ? player.email.join(', ') : player.email || '') : '';
      // Génère dynamiquement la liste des équipes
      let allEquipes = [];
      try { allEquipes = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
      const ul = document.querySelector('#player-teams-checkboxes ul.checkbox-list');
      ul.innerHTML = '';
      allEquipes.forEach(team => {
        const li = document.createElement('li');
        li.className = 'checkbox-row';
        li.innerHTML = `<label class='checkbox-label'><input type='checkbox' name='teams' value="${team.name}"><span class='checkbox-label-text'>${team.name}</span></label>`;
        ul.appendChild(li);
      });
      // Coche les équipes déjà affectées
      if(player && player.teams) {
        ul.querySelectorAll('input[type=checkbox]').forEach(cb => {
          cb.checked = player.teams.includes(cb.value);
        });
      }
      // Affiche ou masque le bouton supprimer
      const delBtn = document.getElementById('delete-player-btn');
      if(player && player.id) {
        delBtn.style.display = 'inline-block';
        delBtn.onclick = function() {
          if(!confirm('Supprimer ce joueur ? Il sera placé dans la corbeille.')) return;
          let players = [];
          let trash = [];
          try { players = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
          try { trash = JSON.parse(localStorage.getItem('players_trash') || '[]'); } catch(e){}
          if(!player.id) return;
          trash.push(players.find(p => p.id === player.id));
          players.splice(players.findIndex(p => p.id === player.id), 1);
          localStorage.setItem('players', JSON.stringify(players));
          localStorage.setItem('players_trash', JSON.stringify(trash));
          document.getElementById('player-modal').style.display = 'none';
          renderPlayersList();
          renderTeamsList();
        };
      } else if(delBtn) {
        delBtn.style.display = 'none';
        delBtn.onclick = null;
      }
      modal.style.display = 'flex';
    }
    // Bouton + joueur
    document.getElementById('add-player-btn').onclick = function() {
      openPlayerModal();
    };
    // Annuler modal joueur
    document.getElementById('cancel-player-btn').onclick = function() {
      document.getElementById('player-modal').style.display = 'none';
    };
    document.querySelector('#player-modal .modal-backdrop').onclick = function() {
      document.getElementById('player-modal').style.display = 'none';
    };
    // Soumission formulaire joueur
    document.getElementById('player-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('player-id-hidden').value || generatePlayerId();
      const name = document.getElementById('player-name').value.trim();
      const birth = document.getElementById('player-birth').value;
      const phone = document.getElementById('player-phone').value.trim();
      const emailRaw = document.getElementById('player-email').value.trim();
      // On accepte séparateur virgule ou retour à la ligne
      const emailArr = emailRaw.split(/[,\n]+/).map(e=>e.trim()).filter(e=>e);
      const email = emailArr.join(', ');
      const teams = Array.from(document.querySelectorAll('#player-teams-checkboxes input[type=checkbox]:checked')).map(cb=>cb.value);
      let players = [];
      try { players = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
      const player = { id, name, birth, phone, email, teams };
      const idx = players.findIndex(p => p.id === id);
      if(idx !== -1) players[idx] = player;
      else players.push(player);
      localStorage.setItem('players', JSON.stringify(players));
      // Synchronisation bidirectionnelle : mise à jour des équipes
      let allTeams = [];
      try { allTeams = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
      allTeams.forEach(team => {
        // Si l'équipe est cochée, on ajoute le joueur si pas déjà présent
        if(teams.includes(team.name)) {
          if(!team.players) team.players = [];
          if(!team.players.includes(id)) team.players.push(id);
        } else {
          // Sinon, on retire le joueur si présent
          if(team.players) team.players = team.players.filter(pid => pid !== id);
        }
      });
      localStorage.setItem('teams', JSON.stringify(allTeams));
      document.getElementById('player-modal').style.display = 'none';
      renderPlayersList();
      renderTeamsList();
    });
    // Affichage initial liste joueurs
    renderPlayersList();
    // Gestion équipes
    function generateTeamId() {
      return 'tm_' + Date.now() + '_' + Math.floor(Math.random()*100000);
    }
    function renderTeamsList() {
      const listDiv = document.getElementById('teams-list');
      let teams = [];
      try { teams = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
      // Toujours garantir que chaque équipe a un champ players tableau
      teams.forEach(team => { if(!Array.isArray(team.players)) team.players = []; });
      teams.sort((a, b) => (b.players?.length||0) - (a.players?.length||0));
      if(teams.length === 0) {
        listDiv.innerHTML = '<p style="color:#888;text-align:center;">Aucune équipe enregistrée.</p>';
        return;
      }
      listDiv.innerHTML = '';
      teams.forEach(team => {
        const div = document.createElement('div');
        div.className = 'team-card';
        div.style = 'background:#fff;border-radius:10px;padding:10px 8px;margin-bottom:10px;box-shadow:0 1px 4px #0001;display:flex;align-items:center;cursor:pointer;';
        let html = `<span style='font-weight:bold;'>${team.name}</span>`;
        if(team.players && team.players.length)
          html += ` <span style='color:#1976d2;font-size:0.95em;'>(${team.players.length} joueur${team.players.length>1?'s':''})</span>`;
        div.innerHTML = html;
        div.onclick = function() { showTeamDetails(team.id); };
        listDiv.appendChild(div);
      });
    }
    // Affiche la fiche équipe
    function showTeamDetails(teamId) {
      // Toujours réafficher la liste des joueurs et le bouton + joueur pour éviter blocage navigation
      document.getElementById('players-list').style.display = 'block';
      document.getElementById('add-player-btn').style.display = 'block';
      let teams = [];
      try { teams = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
      const team = teams.find(t => t.id === teamId);
      if(!team) return;
      // Récupère les joueurs
      let players = [];
      try { players = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
      const playerObjs = (team.players||[]).map(pid => players.find(pl => pl.id === pid)).filter(Boolean);
      const playerNames = playerObjs.map(p => p.name);
      // --- Statistiques de présence pour l'équipe ---
      let events = [];
      try { events = JSON.parse(localStorage.getItem('events') || '[]'); } catch(e){}
      let presences = 0;
      let totalMinutes = 0;
      let weekly = {};
      let weeklyMinutes = {};
      let seasonCounts = {};
      let currentSeason = getSeasonFromDate((new Date()).toISOString().slice(0,10));
      let currentSeasonCount = 0;
      let currentSeasonMinutes = 0;
      events.forEach(ev => {
        if(ev.joueursPresents) {
          // Pour chaque joueur de l'équipe, s'il est présent à l'événement
          playerNames.forEach(name => {
            if(ev.joueursPresents.includes(name)) {
              presences++;
              // Semaine ISO
              const d = new Date(ev.date);
              const y = d.getFullYear();
              const week = getWeekNumber(d);
              const key = y + '-W' + week;
              weekly[key] = (weekly[key]||0) + 1;
              // --- Ajout : temps par semaine ---
              if(ev.startTime && ev.endTime) {
                const min = getDurationMinutes(ev.startTime, ev.endTime);
                weeklyMinutes[key] = (weeklyMinutes[key]||0) + min;
                totalMinutes += min;
                const season = getSeasonFromDate(ev.date);
                if(season === currentSeason) currentSeasonMinutes += min;
              }
              // Saison
              const season = getSeasonFromDate(ev.date);
              seasonCounts[season] = (seasonCounts[season]||0) + 1;
              if(season === currentSeason) currentSeasonCount++;
            }
          });
        }
      });
      // Formatage durée
      function formatMinutes(mins) {
        const h = Math.floor(mins/60);
        const m = mins%60;
        return (h ? (h+' h ') : '') + m + ' min';
      }
      // Graphique 7 dernières semaines
      const weeks = getLastNWeeks(7);
      const maxVal = Math.max(1, ...weeks.map(w => weekly[w]||0));
      let bars = weeks.map(w => `<div style='flex:1;margin:0 2px;display:flex;flex-direction:column;align-items:center;'><div style='height:${Math.round(40*(weekly[w]||0)/maxVal)}px;width:18px;background:#1976d2;border-radius:4px 4px 0 0;'></div><span style='font-size:0.8em;color:#888;'>${w.slice(5)}</span></div>`).join('');
      let graph = `<div style='display:flex;align-items:end;height:48px;margin:8px 0 0 0;'>${bars}</div>`;
      // Historique par saison (trié du plus récent au plus ancien)
      let seasonsSorted = Object.keys(seasonCounts).sort((a,b)=>b.localeCompare(a));
      let seasonHistory = seasonsSorted.map(s => `<div>${s} : <strong>${seasonCounts[s]}</strong></div>`).join('');
      // --- Ajout : graphique hebdomadaire enrichi (joueur et équipe) ---
      function renderWeeklyGraph(weekly, weeklyMinutes, onBarClick) {
        // Récupère toutes les semaines où il y a eu au moins 1 présence
        const allWeeks = Object.keys(weekly).concat(Object.keys(weeklyMinutes)).filter((v,i,a)=>a.indexOf(v)===i);
        allWeeks.sort();
        if(allWeeks.length === 0) return '<div style="color:#888;">Aucune donnée</div>';
        // Découpe en groupes de 7 semaines
        const graphs = [];
        for(let i=0; i<allWeeks.length; i+=7) {
          const weeks = allWeeks.slice(i, i+7);
          // Valeurs max pour l'échelle (sur toutes les semaines, pour garder la même échelle)
          const maxCount = Math.max(...allWeeks.map(w => weekly[w]||0), 1);
          const maxMinutes = Math.max(...allWeeks.map(w => weeklyMinutes[w]||0), 1);
          // Largeur du conteneur (100% de la fenêtre ou parent)
          const containerW = Math.max(320, window.innerWidth - 64);
          const barW = weeks.length > 1 ? Math.floor(containerW / weeks.length) : containerW;
          const H = 60;
          const scaleY = 5/6;
          let points = weeks.map((w,j) => {
            const x = j*barW + barW/2;
            const y = H - Math.round((weeklyMinutes[w]||0)/maxMinutes*H*scaleY);
            return `${x},${y}`;
          }).join(' ');
          let svg = `<svg width='${containerW}' height='${H+24}' style='overflow:visible;min-width:100%;'>`;
          weeks.forEach((w,j) => {
            const x = j*barW;
            const h = Math.round((weekly[w]||0)/maxCount*H*scaleY);
            svg += `<rect x='${x+Math.max(8,barW/8)}' y='${H-h}' width='${Math.max(20,barW-16)}' height='${h}' fill='#1976d2' rx='4'/>`;
            svg += `<rect class='weekly-graph-barzone' x='${x+Math.max(8,barW/8)}' y='${H-H*scaleY}' width='${Math.max(20,barW-16)}' height='${H*scaleY}' data-week='${w}' style='pointer-events:all;fill:transparent;'/>`;
          });
          svg += `<line x1='0' y1='${H}' x2='${containerW}' y2='${H}' stroke='#bbb'/>`;
          svg += `<line x1='0' y1='0' x2='0' y2='${H}' stroke='#bbb'/>`;
          weeks.forEach((w,j) => {
            const x = j*barW + barW/2;
            svg += `<text x='${x}' y='${H+14}' text-anchor='middle' font-size='10' fill='#888'>${w.slice(5)}</text>`;
          });
          svg += '</svg>';
          graphs.push(`<div style='width:100%;padding-bottom:8px;position:relative;' class='weekly-graph-container' data-weeks='${JSON.stringify(weeks)}'>
            ${svg}
            <div class='weekly-graph-popup' style='display:none;position:absolute;z-index:10;border-radius:8px;padding:6px 12px;box-shadow:0 2px 8px #0002;font-size:0.98em;'></div>
          </div>`);
        }
        // --- Ajout : interactivité du popup sur TOUS les graphes après leur insertion ---
        setTimeout(() => {
          document.querySelectorAll('.weekly-graph-container').forEach((graphDiv, idx) => {
            // Récupère les semaines de ce graphe
            let weeks = [];
            try { weeks = JSON.parse(graphDiv.getAttribute('data-weeks')); } catch(e){}
            // On reconstitue les weekly/weeklyMinutes locaux à ce graphe
            const localWeekly = {};
            const localWeeklyMinutes = {};
            weeks.forEach(w => { localWeekly[w] = weekly[w]||0; localWeeklyMinutes[w] = weeklyMinutes[w]||0; });
            const popup = graphDiv.querySelector('.weekly-graph-popup');
            Array.from(graphDiv.querySelectorAll('.weekly-graph-barzone, circle')).forEach(el => {
              el.onclick = function(e) {
                const week = this.getAttribute('data-week');
                if(!week) return;
                const n = localWeekly[week]||0;
                const t = localWeeklyMinutes[week]||0;
                popup.innerHTML = `<strong>Semaine ${week.slice(5)}</strong><br>Nombre de séances : <b>${n}</b><br>Temps : <b>${formatMinutes(t)}</b>`;
                popup.style.display = 'block';
                // Style thème (forcé)
                const root = document.documentElement;
                const card = getComputedStyle(root).getPropertyValue('--card') || '#111';
                const fg = getComputedStyle(root).getPropertyValue('--fg') || '#fff';
                const secondary = getComputedStyle(root).getPropertyValue('--secondary') || '#1976d2';
                popup.style.background = card + ' !important';
                popup.style.color = fg + ' !important';
                popup.style.border = '1px solid ' + secondary;
                popup.style.boxShadow = '0 2px 8px #0002';
                // Position popup centrée sur la barre
                const rect = this.getBoundingClientRect();
                const parentRect = graphDiv.getBoundingClientRect();
                popup.style.left = (rect.left-parentRect.left+rect.width/2-60)+'px';
                popup.style.top = (rect.top-parentRect.top-38)+'px';
              };
            });
            graphDiv.addEventListener('mouseleave', ()=>{ popup.style.display='none'; });
          });
        }, 0);
        return graphs.join('');
      }
      // Affichage fiche équipe
      const details = document.getElementById('team-details');
      const playerBadges = playerObjs.map(p =>
        `<span class='player-link-badge' data-player-id='${p.id}' style='display:inline-block;margin:2px 8px 2px 0;padding:2px 8px;background:#e3eafc;border-radius:8px;cursor:pointer;color:var(--secondary,#1976d2);text-decoration:underline;'>${p.name}</span>`
      ).join('');
      details.innerHTML = `
        <button id='team-back-btn' style='margin-bottom:10px;'>&larr; ${translations[getLang()]['back']||'Retour'}</button>
        <h3 style='margin-top:0;'>${team.name}</h3>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['players']||'Joueurs affectés :'} </strong><br>${playerBadges || `<span style="color:#888;">${translations[getLang()]['no_player']||'Aucun joueur'}</span>`}</div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['total_presences']||'Présences totales :'} </strong> ${presences}</div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['total_time']||'Temps total :'} </strong> ${formatMinutes(totalMinutes)}</div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['season_presences']||'Présences cette saison :'} (${currentSeason})</strong> ${currentSeasonCount}</div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['season_time']||'Temps cette saison :'} </strong> ${formatMinutes(currentSeasonMinutes)}</div>
        <div style='margin-bottom:8px;max-width:100%;overflow-x:auto;'><strong>${translations[getLang()]['weekly_stats']||'Présences/temps par semaine :'} </strong>${renderWeeklyGraph(weekly, weeklyMinutes)}</div>
        <div style='margin-bottom:8px;'><strong>${translations[getLang()]['season_history']||'Historique par saison :'} </strong>${seasonHistory}</div>
        <button id='team-edit-btn' style='margin-top:10px;'>${translations[getLang()]['edit']||'Modifier'}</button>
      `;
      // Rends la fiche scrollable si besoin
      details.style.maxHeight = '70vh';
      details.style.overflowY = 'auto';
      // Interactivité du graphique
      const graphDiv = details.querySelector('.weekly-graph-container');
      if(graphDiv) {
        const popup = graphDiv.querySelector('.weekly-graph-popup');
        graphDiv.querySelectorAll('.weekly-graph-barzone, circle').forEach(el => {
          el.addEventListener('click', function(e) {
            const week = this.getAttribute('data-week');
            if(!week) return;
            const n = weekly[week]||0;
            const t = weeklyMinutes[week]||0;
            popup.innerHTML = `<strong>Semaine ${week.slice(5)}</strong><br>Nombre de séances : <b>${n}</b><br>Temps : <b>${formatMinutes(t)}</b>`;
            popup.style.display = 'block';
            // Style thème (forcé)
            const root = document.documentElement;
            const card = getComputedStyle(root).getPropertyValue('--card') || '#111';
            const fg = getComputedStyle(root).getPropertyValue('--fg') || '#fff';
            const secondary = getComputedStyle(root).getPropertyValue('--secondary') || '#1976d2';
            popup.style.background = card + ' !important';
            popup.style.color = fg + ' !important';
            popup.style.border = '1px solid ' + secondary;
            popup.style.boxShadow = '0 2px 8px #0002';
            // Position popup centrée sur la barre
            const rect = this.getBoundingClientRect();
            const parentRect = graphDiv.getBoundingClientRect();
            popup.style.left = (rect.left-parentRect.left+rect.width/2-60)+'px';
            popup.style.top = (rect.top-parentRect.top-38)+'px';
          });
        });
        graphDiv.addEventListener('mouseleave', ()=>{ popup.style.display='none'; });
      }
      document.getElementById('teams-list').style.display = 'none';
      details.style.display = 'block';
      document.getElementById('add-team-btn').style.display = 'none';
      document.getElementById('team-back-btn').onclick = function() {
        details.style.display = 'none';
        document.getElementById('teams-list').style.display = 'block';
        document.getElementById('add-team-btn').style.display = 'block';
      };
      document.getElementById('team-edit-btn').onclick = function() {
        openTeamModal(team.id);
      };
      // Ajoute l'écouteur de clic sur chaque badge joueur
      Array.from(details.querySelectorAll('.player-link-badge')).forEach(el => {
        el.onclick = function(e) {
          const pid = this.getAttribute('data-player-id');
          if(pid) {
            // Active l'onglet joueurs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-players').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn[data-tab="players"]').classList.add('active');
            // Mémorise l'équipe d'origine pour le retour
            window.previousTeamId = team.id;
            details.style.display = 'none';
            document.getElementById('teams-list').style.display = 'none';
            document.getElementById('add-team-btn').style.display = 'none';
            showPlayerDetails(pid);
          }
        };
      });
    }
    // Ouvre le modal d'ajout/modif équipe
    function openTeamModal(teamId) {
      const modal = document.getElementById('team-modal');
      const form = document.getElementById('team-form');
      let team = null;
      if(teamId) {
        let teams = [];
        try { teams = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
        team = teams.find(t => t.id === teamId);
      }
      document.getElementById('team-modal-title').innerText = team ? 'Modifier équipe' : 'Nouvelle équipe';
      form.reset();
      document.getElementById('team-id-hidden').value = team ? team.id : '';
      document.getElementById('team-name').value = team ? team.name : '';
      // Génère la liste des joueurs existants
      let players = [];
      try { players = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
      players.sort((a, b) => (a.name||'').localeCompare(b.name||''));
      const ul = document.getElementById('team-players-list');
      ul.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        li.className = 'checkbox-row';
        li.innerHTML = `<label class='checkbox-label'><input type='checkbox' name='players' value="${p.id}"><span class='checkbox-label-text'>${p.name}</span></label>`;
        ul.appendChild(li);
      });
      // Coche les joueurs déjà affectés
      if(team && team.players) {
        ul.querySelectorAll('input[type=checkbox]').forEach(cb => {
          cb.checked = team.players.includes(cb.value);
        });
      }
      // Affiche ou masque le bouton supprimer
      const delBtn = document.getElementById('delete-team-btn');
      if(team && team.id) {
        delBtn.style.display = 'inline-block';
        delBtn.onclick = function() {
          if(!confirm('Supprimer cette équipe ? Elle sera placée dans la corbeille.')) return;
          let teams = [];
          let trash = [];
          try { teams = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
          try { trash = JSON.parse(localStorage.getItem('teams_trash') || '[]'); } catch(e){}
          if(!team.id) return;
          const toTrash = teams.find(t => t.id === team.id);
          if(toTrash) trash.push(toTrash);
          teams.splice(teams.findIndex(t => t.id === team.id), 1);
          localStorage.setItem('teams', JSON.stringify(teams));
          localStorage.setItem('teams_trash', JSON.stringify(trash));
          document.getElementById('team-modal').style.display = 'none';
          renderTeamsList();
          renderPlayersList();
          // Correction : masque la fiche équipe et affiche la liste, même si la suppression vient de la fiche
          document.getElementById('teams-list').style.display = 'block';
          document.getElementById('team-details').style.display = 'none';
          document.getElementById('add-team-btn').style.display = 'block';
        };
      } else if(delBtn) {
        delBtn.style.display = 'none';
        delBtn.onclick = null;
      }
      modal.style.display = 'flex';
    }
    // Bouton + équipe
    document.getElementById('add-team-btn').onclick = function() {
      openTeamModal();
    };
    // Annuler modal équipe
    document.getElementById('cancel-team-btn').onclick = function() {
      document.getElementById('team-modal').style.display = 'none';
    };
    document.querySelector('#team-modal .modal-backdrop').onclick = function() {
      document.getElementById('team-modal').style.display = 'none';
    };
    // Soumission formulaire équipe
    document.getElementById('team-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('team-id-hidden').value || generateTeamId();
      const name = document.getElementById('team-name').value.trim();
      const players = Array.from(document.querySelectorAll('#team-players-list input[type=checkbox]:checked')).map(cb=>cb.value);
      let teams = [];
      try { teams = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
      const team = { id, name, players };
      const idx = teams.findIndex(t => t.id === id);
      if(idx !== -1) teams[idx] = team;
      else teams.push(team);
      localStorage.setItem('teams', JSON.stringify(teams));
      // Synchronisation bidirectionnelle : mise à jour des joueurs
      let allPlayers = [];
      try { allPlayers = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
      allPlayers.forEach(p => {
        // Toujours garantir que p.teams est un tableau
        if(!Array.isArray(p.teams)) p.teams = [];
        // On récupère la liste des équipes du joueur (hors celle en cours)
        p.teams = p.teams.filter(tn => tn !== name);
        // Si le joueur est coché, on ajoute l'équipe à sa liste
        if(players.includes(p.id)) {
          p.teams.push(name);
        }
      });
      localStorage.setItem('players', JSON.stringify(allPlayers));
      document.getElementById('team-modal').style.display = 'none';
      renderTeamsList();
      renderPlayersList();
      // Si modification, afficher la fiche équipe actualisée
      if(document.getElementById('team-id-hidden').value) {
        setTimeout(function(){ showTeamDetails(id); }, 10);
      }
    });
    // Affichage initial liste équipes
    renderTeamsList();
    // --- Formulaire d'événement : équipes conviées dynamiques ---
    function renderEventFormTeamsAndPlayers() {
      // Équipes
      let allEquipes = [];
      try { allEquipes = JSON.parse(localStorage.getItem('teams') || '[]'); } catch(e){}
      allEquipes.sort((a, b) => (b.players?.length||0) - (a.players?.length||0));
      const eqDiv = document.getElementById('event-equipes-checkboxes');
      eqDiv.innerHTML = '<ul class="checkbox-list">' +
        allEquipes.map(team => `<li class="checkbox-row"><label class="checkbox-label"><input type="checkbox" name="equipes" value="${team.name}"><span class='checkbox-label-text'>${team.name}</span></label></li>`).join('') +
        '</ul>';
      // Joueurs (pour la sélection au cas par cas)
      let allJoueurs = [];
      try { allJoueurs = JSON.parse(localStorage.getItem('players') || '[]'); } catch(e){}
      allJoueurs.sort((a, b) => (a.name||'').localeCompare(b.name||''));
      const jpDiv = document.getElementById('event-players-checkboxes');
      jpDiv.innerHTML = '<strong>Joueurs invités :</strong><ul class="checkbox-list">' +
        allJoueurs.map(p => `<li class="checkbox-row"><label class="checkbox-label"><input type="checkbox" name="players" value="${p.name}"><span class='checkbox-label-text'>${p.name}</span></label></li>`).join('') +
        '</ul>';
    }
    // --- Thème visuel ---
    function applyTheme(theme) {
      if(theme === 'system') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
    }
    document.getElementById('theme-select').addEventListener('change', function() {
      localStorage.setItem('theme', this.value);
      applyTheme(this.value);
    });
    // Ajout de l'option OLED si pas déjà présente
    (function(){
      const sel = document.getElementById('theme-select');
      if(![...sel.options].some(o=>o.value==='oled')) {
        const opt = document.createElement('option');
        opt.value = 'oled';
        opt.textContent = 'Noir OLED';
        sel.appendChild(opt);
      }
    })();
    // --- Inversion de la timeline ---
    document.getElementById('timeline-order-checkbox').addEventListener('change', function() {
      localStorage.setItem('timelineOrder', this.checked ? 'asc' : 'desc');
      renderTimeline();
    });
    // Appliquer l'ordre au chargement
    (function(){
      const o = localStorage.getItem('timelineOrder') || 'desc';
      const cb = document.getElementById('timeline-order-checkbox');
      cb.checked = (o === 'asc');
      // Afficher le conteneur au cas où il serait masqué
      document.getElementById('timeline-order-container').style.display = 'block';
      // Log pour debug
      console.log('Case à cocher timeline visible:', cb, cb.parentElement, cb.offsetParent !== null);
    })();
    // --- Appliquer le thème au chargement ---
    (function(){
      const t = localStorage.getItem('theme') || 'system';
      document.getElementById('theme-select').value = t;
      applyTheme(t);
    })();
    // --- Export JSON ---
    document.getElementById('export-json-btn').onclick = function() {
      const data = {
        events: JSON.parse(localStorage.getItem('events')||'[]'),
        players: JSON.parse(localStorage.getItem('players')||'[]'),
        teams: JSON.parse(localStorage.getItem('teams')||'[]')
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      // Ajout de la date au format aaaa-mm-jj-hh-min-sec
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const dateStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}-${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;
      a.download = `sport_presence_data_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    };
    // --- Import JSON ---
    document.getElementById('import-json-btn').onclick = function() {
      document.getElementById('import-json-input').click();
    };
    document.getElementById('import-json-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = JSON.parse(evt.target.result);
          const mode = document.querySelector('input[name="import-mode"]:checked').value;
          if(mode === 'replace') {
            if(confirm('Remplacer toutes les données existantes par celles du fichier ?')) {
              localStorage.setItem('events', JSON.stringify(data.events||[]));
              localStorage.setItem('players', JSON.stringify(data.players||[]));
              localStorage.setItem('teams', JSON.stringify(data.teams||[]));
              location.reload();
            }
          } else {
            // Fusionner
            let events = JSON.parse(localStorage.getItem('events')||'[]');
            let players = JSON.parse(localStorage.getItem('players')||'[]');
            let teams = JSON.parse(localStorage.getItem('teams')||'[]');
            // Ajoute sans doublons (par id)
            const mergeById = (arr, arr2, key) => {
              const ids = new Set(arr.map(x=>x.id));
              arr2.forEach(x => { if(x.id && !ids.has(x.id)) arr.push(x); });
              return arr;
            };
            events = mergeById(events, data.events||[], 'id');
            players = mergeById(players, data.players||[], 'id');
            teams = mergeById(teams, data.teams||[], 'id');
            localStorage.setItem('events', JSON.stringify(events));
            localStorage.setItem('players', JSON.stringify(players));
            localStorage.setItem('teams', JSON.stringify(teams));
            location.reload();
          }
        } catch(e) { alert('Erreur lors de l\'import : ' + e); }
      };
      reader.readAsText(file);
    });
    // --- Langue (démo) ---
    document.getElementById('lang-select').addEventListener('change', function() {
      localStorage.setItem('lang', this.value);
      // (Pour la démo, pas de traduction effective)
    });
    // Appliquer la langue au chargement
    (function(){
      const l = localStorage.getItem('lang') || 'fr';
      document.getElementById('lang-select').value = l;
    })();

    function translateUI(lang) {
      // Textes simples
      document.querySelectorAll('#settings-content label').forEach(el => {
        // Si le label contient un input, on ne traduit que le texte après l'input
        const input = el.querySelector('input');
        if(input && el.childNodes.length > 1) {
          // On cherche le noeud texte après l'input
          for(let i=0; i<el.childNodes.length; i++) {
            if(el.childNodes[i].nodeType === Node.TEXT_NODE && el.childNodes[i].textContent.trim() !== '') {
              const txt = el.childNodes[i].textContent.trim();
              if(translations[lang][txt]) el.childNodes[i].textContent = ' ' + translations[lang][txt];
            }
          }
        } else {
          const txt = el.textContent.trim();
          if(translations[lang][txt]) el.textContent = translations[lang][txt];
        }
      });
      // Traduction des autres éléments
      document.querySelectorAll('#settings-content strong, #settings-content button, #settings-content option, #settings-content pre, #settings-content input[type="radio"]+label, #settings-content input[type="checkbox"]+label').forEach(el => {
        const txt = el.textContent.trim();
        if(translations[lang][txt]) el.textContent = translations[lang][txt];
      });
      // Placeholder pour d'autres éléments si besoin
      document.getElementById('copy-json-example').textContent = translations[lang]['Copier'];
      document.getElementById('export-json-btn').textContent = translations[lang]['Exporter'];
      document.getElementById('import-json-btn').textContent = translations[lang]['Importer'];
      document.getElementById('delete-all-btn').textContent = translations[lang]['Tout supprimer'];
      document.getElementById('lang-select').options[0].textContent = translations[lang]['Français'];
      document.getElementById('lang-select').options[1].textContent = translations[lang]['English'];
      document.getElementById('lang-select').options[2].textContent = translations[lang]['Español'];
      // Thème select
      const themeSel = document.getElementById('theme-select');
      themeSel.options[0].textContent = translations[lang]['Système'];
      themeSel.options[1].textContent = translations[lang]['Clair'];
      themeSel.options[2].textContent = translations[lang]['Sombre'];
      if(themeSel.options[3]) themeSel.options[3].textContent = translations[lang]['Noir OLED'];
    }
    // Appliquer la langue au chargement et au changement
    function setLang(lang) {
      localStorage.setItem('lang', lang);
      translateUI(lang);
    }
    document.getElementById('lang-select').addEventListener('change', function() {
      setLang(this.value);
    });
    (function(){
      const l = localStorage.getItem('lang') || 'fr';
      document.getElementById('lang-select').value = l;
      setLang(l);
    })();
    document.getElementById('copy-json-example').onclick = function() {
      const txt = document.getElementById('json-example').innerText;
      navigator.clipboard.writeText(txt);
      this.textContent = (localStorage.getItem('lang')||'fr')==='en' ? 'Copied!' : 'Copié !';
      setTimeout(()=>{this.textContent=(localStorage.getItem('lang')||'fr')==='en' ? 'Copy' : 'Copier';},1200);
    };
    // --- Traduction FR/EN/ES dynamique sur toute l'interface ---
    function applyTranslations(lang) {
      // Traduction des éléments avec data-i18n
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(translations[lang][key]) el.textContent = translations[lang][key];
      });
      // Traduction des titres de boutons + (title)
      document.querySelectorAll('[data-i18n-title]').forEach(el => {
        const key = el.getAttribute('data-i18n-title');
        if(translations[lang][key]) el.title = translations[lang][key];
      });
      // Traduction des onglets de navigation
      // const navTabKeys = {
      //   'timeline': 'timeline_title',
      //   'teams': 'teams_title',
      //   'players': 'players_title',
      //   'settings': 'settings_title'
      // };
      // document.querySelectorAll('.nav-btn').forEach(btn => {
      //   const tab = btn.dataset.tab;
      //   if(navTabKeys[tab]) {
      //     // On garde l'emoji
      //     const span = btn.querySelector('span');
      //     if(span) {
      //       span.nextSibling && span.nextSibling.remove();
      //       span.insertAdjacentText('afterend', translations[lang][navTabKeys[tab]]);
      //     }
      //   }
      // });
      // Traduction des messages dynamiques principaux
      // Timeline vide
      const timelineContent = document.getElementById('timeline-content');
      if(timelineContent && timelineContent.children.length === 0) {
        timelineContent.innerHTML = `<p style="color:#888;text-align:center;">${translations[lang]['no_event']||'Aucun événement pour l\'instant.'}</p>`;
      }
      // Liste joueurs vide
      const playersList = document.getElementById('players-list');
      if(playersList && playersList.children.length === 0) {
        playersList.innerHTML = `<p style="color:#888;text-align:center;">${translations[lang]['no_player']||'Aucun joueur enregistré.'}</p>`;
      }
      // Liste équipes vide
      const teamsList = document.getElementById('teams-list');
      if(teamsList && teamsList.children.length === 0) {
        teamsList.innerHTML = `<p style="color:#888;text-align:center;">${translations[lang]['no_team']||'Aucune équipe enregistrée.'}</p>`;
      }
      // Corbeille vide
      const trashList = document.getElementById('trash-list');
      if(trashList && trashList.children.length === 0) {
        trashList.innerHTML = `<p style="color:#888;">${translations[lang]['trash_empty']||'Corbeille vide.'}</p>`;
      }
      // Traduction dynamique des options du select Description
      translateEventDescriptionOptions(lang);
    }
    // Ajout des clés dynamiques dans translations
    translations.fr.no_event = "Aucun événement pour l'instant.";
    translations.en.no_event = "No event yet.";
    translations.es.no_event = "Ningún evento por ahora.";
    translations.fr.no_player = "Aucun joueur enregistré.";
    translations.en.no_player = "No player registered.";
    translations.es.no_player = "Ningún jugador registrado.";
    translations.fr.no_team = "Aucune équipe enregistrée.";
    translations.en.no_team = "No team registered.";
    translations.es.no_team = "Ningún equipo registrado.";
    translations.fr.trash_empty = "Corbeille vide.";
    translations.en.trash_empty = "Trash empty.";
    translations.es.trash_empty = "Papelera vacía.";
    // Appel initial au chargement
    (function(){
      const l = localStorage.getItem('lang') || 'fr';
      applyTranslations(l);
    })();
    // Appel à chaque changement de langue
    document.getElementById('lang-select').addEventListener('change', function() {
      setLang(this.value);
      applyTranslations(this.value);
    });
    // Appel aussi dans setLang
    function setLang(lang) {
      localStorage.setItem('lang', lang);
      translateUI(lang);
      applyTranslations(lang);
    }
    // Traduction dynamique des options du select Description
    function translateEventDescriptionOptions(lang) {
      const descSelect = document.getElementById('event-description-type');
      if(!descSelect) return;
      const optionKeys = [
        {value: "Sous l'eau", key: 'desc_sousleau'},
        {value: "Séance vidéo", key: 'desc_video'},
        {value: "Course", key: 'desc_course'},
        {value: "Renfo", key: 'desc_renfo'},
        {value: "Stage", key: 'desc_stage'},
        {value: "Tournois", key: 'desc_tournois'},
        {value: "Championnat", key: 'desc_championnat'},
        {value: "autre", key: 'desc_autre'}
      ];
      for(let i=0; i<descSelect.options.length; i++) {
        const opt = descSelect.options[i];
        const found = optionKeys.find(o => o.value === opt.value || o.value === opt.text);
        if(found && translations[lang][found.key]) {
          opt.text = translations[lang][found.key];
        }
      }
    }
    // --- Traductions pour les modes d'affichage ---
    translations.fr.timeline_view_mode = "Affichage de la Timeline :";
    translations.en.timeline_view_mode = "Timeline view mode:";
    translations.es.timeline_view_mode = "Modo de vista de la línea de tiempo:";
    translations.fr.timeline_view_compact = "Vue compacte";
    translations.en.timeline_view_compact = "Compact view";
    translations.es.timeline_view_compact = "Vista compacta";
    translations.fr.timeline_view_detailed = "Vue détaillée";
    translations.en.timeline_view_detailed = "Detailed view";
    translations.es.timeline_view_detailed = "Vista detallada";
    translations.fr.timeline_view_split = "Vue mixte (compacte + détaillée)";
    translations.en.timeline_view_split = "Split view (compact + detailed)";
    translations.es.timeline_view_split = "Vista mixta (compacta + detallada)";
    // --- Gestion du mode d'affichage de la timeline ---
    function getTimelineViewMode() {
      return localStorage.getItem('timelineViewMode') || 'compact';
    }
    function setTimelineViewMode(mode) {
      localStorage.setItem('timelineViewMode', mode);
    }
    // Initialisation du sélecteur au chargement
    (function(){
      const mode = getTimelineViewMode();
      document.getElementById('timeline-view-compact').checked = (mode === 'compact');
      document.getElementById('timeline-view-detailed').checked = (mode === 'detailed');
      document.getElementById('timeline-view-split').checked = (mode === 'split');
    })();
    // Listener sur les radios
    document.querySelectorAll('input[name="timeline-view-mode"]').forEach(radio => {
      radio.addEventListener('change', function() {
        if(this.checked) {
          setTimelineViewMode(this.value);
          renderTimeline();
        }
      });
    });
    // Helper pour obtenir la saison à partir d'une date (format YYYY-MM-DD)
    function getSeasonFromDate(dateStr) {
      const d = new Date(dateStr);
      let year = d.getFullYear();
      const month = d.getMonth() + 1; // 1-12
      // Si avant septembre, on est encore dans la saison de l'année précédente
      if(month < 9) {
        return (year-1) + '-' + year;
      } else {
        return year + '-' + (year+1);
      }
    }
    // --- JS pour la couleur secondaire ---
    (function(){
      const root = document.documentElement;
      const picker = document.getElementById('secondary-color-picker');
      const presetDiv = document.getElementById('secondary-color-preset');
      // Valeur par défaut
      let color = localStorage.getItem('secondaryColor') || '#1976d2';
      root.style.setProperty('--secondary', color);
      picker.value = color;
      // Quand on change la couleur via le color picker
      picker.addEventListener('input', function() {
        root.style.setProperty('--secondary', this.value);
        localStorage.setItem('secondaryColor', this.value);
        // Met à jour le style des pastilles
        presetDiv.querySelectorAll('.color-preset').forEach(btn => btn.style.borderColor = (btn.dataset.color.toLowerCase() === this.value.toLowerCase() ? '#000' : '#ccc'));
      });
      // Quand on clique sur une couleur prédéfinie
      presetDiv.querySelectorAll('.color-preset').forEach(btn => {
        btn.addEventListener('click', function() {
          root.style.setProperty('--secondary', btn.dataset.color);
          picker.value = btn.dataset.color;
          localStorage.setItem('secondaryColor', btn.dataset.color);
          presetDiv.querySelectorAll('.color-preset').forEach(b => b.style.borderColor = (b === btn ? '#000' : '#ccc'));
        });
        // Bordure active si sélectionnée
        btn.style.borderColor = (btn.dataset.color.toLowerCase() === color.toLowerCase() ? '#000' : '#ccc');
      });
    })();
  </script>
+  <!-- SVG Icons -->
+  <svg style="display:none;">
+    <symbol id="icon-calendar" viewBox="0 0 225 225">
+      <g transform="translate(0.000000,225.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
+        <path d="M575 2236 c-67 -30 -105 -96 -105 -182 l0 -41 -77 -7 c-93 -7 -148 -32 -202 -91 -74 -80 -72 -52 -69 -936 l3 -784 31 -55 c33 -60 99 -112 162 -130 51 -14 1563 -14 1614 0 63 18 129 70 162 130 l31 55 3 784 c3 884 5 856 -69 936 -52 56 -106 82 -191 90 l-68 7 0 37 c0 113 -74 201 -168 201 -16 0 -48 -10 -72 -23 -57 -30 -90 -90 -90 -164 l0 -53 -85 0 -85 0 0 43 c0 69 -17 112 -60 150 -112 102 -270 20 -270 -141 l0 -52 -85 0 -85 0 0 53 c0 131 -117 221 -225 173z m90 -82 c37 -15 45 -56 45 -234 0 -168 0 -171 -25 -195 -38 -39 -86 -32 -110 16 -19 35 -21 334 -4 373 16 35 58 53 94 40z m506 -7 c34 -26 39 -55 39 -217 0 -122 -4 -168 -15 -189 -24 -48 -72 -55 -111 -16 l-25 25 3 186 c3 181 4 186 27 205 26 22 59 24 82 6z m506 -11 l28 -24 3 -163 c4 -178 1 -200 -28 -229 -27 -27 -66 -25 -95 5 -25 24 -25 26 -25 205 0 179 0 181 25 205 30 31 56 32 92 1z m293 -1214 c0 -774 4 -729 -66 -758 -49 -21 -1509 -21 -1558 0 -70 29 -66 -16 -66 758 l0 698 845 0 845 0 0 -698z"/>
+        <path d="M420 1225 l0 -125 140 0 140 0 0 125 0 125 -140 0 -140 0 0 -125z"/>
+        <path d="M797 1344 c-4 -4 -7 -61 -7 -126 l0 -118 145 0 146 0 -3 123 -3 122 -136 3 c-74 1 -138 -1 -142 -4z"/>
+        <path d="M1177 1344 c-4 -4 -7 -61 -7 -126 l0 -118 145 0 146 0 -3 123 -3 122 -136 3 c-74 1 -138 -1 -142 -4z"/>
+        <path d="M1550 1225 l0 -125 140 0 140 0 0 125 0 125 -140 0 -140 0 0 -125z"/>
+        <path d="M420 885 l0 -125 140 0 140 0 0 125 0 125 -140 0 -140 0 0 -125z"/>
+        <path d="M790 885 l0 -125 145 0 145 0 0 125 0 125 -145 0 -145 0 0 -125z"/>
+        <path d="M1170 885 l0 -125 145 0 145 0 0 125 0 125 -145 0 -145 0 0 -125z"/>
+        <path d="M1550 885 l0 -125 140 0 140 0 0 125 0 125 -140 0 -140 0 0 -125z"/>
+        <path d="M420 545 l0 -125 140 0 140 0 0 125 0 125 -140 0 -140 0 0 -125z"/>
+        <path d="M792 548 l3 -123 143 -3 142 -3 0 126 0 125 -145 0 -146 0 3 -122z"/>
+        <path d="M1170 545 l0 -126 143 3 142 3 3 123 3 122 -146 0 -145 0 0 -125z"/>
+        <path d="M1550 545 l0 -125 140 0 140 0 0 125 0 125 -140 0 -140 0 0 -125z"/>
+      </g>
+    </symbol>
+    <symbol id="icon-settings" viewBox="0 0 478.703 478.703">
+      <g>
+        <g>
+          <path d="M454.2,189.101l-33.6-5.7c-3.5-11.3-8-22.2-13.5-32.6l19.8-27.7c8.4-11.8,7.1-27.9-3.2-38.1l-29.8-29.8 c-5.6-5.6-13-8.7-20.9-8.7c-6.2,0-12.1,1.9-17.1,5.5l-27.8,19.8c-10.8-5.7-22.1-10.4-33.8-13.9l-5.6-33.2 c-2.4-14.3-14.7-24.7-29.2-24.7h-42.1c-14.5,0-26.8,10.4-29.2,24.7l-5.8,34c-11.2,3.5-22.1,8.1-32.5,13.7l-27.5-19.8 c-5-3.6-11-5.5-17.2-5.5c-7.9,0-15.4,3.1-20.9,8.7l-29.9,29.8c-10.2,10.2-11.6,26.3-3.2,38.1l20,28.1 c-5.5,10.5-9.9,21.4-13.3,32.7l-33.2,5.6c-14.3,2.4-24.7,14.7-24.7,29.2v42.1c0,14.5,10.4,26.8,24.7,29.2l34,5.8 c3.5,11.2,8.1,22.1,13.7,32.5l-19.7,27.4c-8.4,11.8-7.1,27.9,3.2,38.1l29.8,29.8c5.6,5.6,13,8.7,20.9,8.7c6.2,0,12.1-1.9,17.1-5.5 l28.1-20c10.1,5.3,20.7,9.6,31.6,13l5.6,33.6c2.4,14.3,14.7,24.7,29.2,24.7h42.2c14.5,0,26.8-10.4,29.2-24.7l5.7-33.6 c11.3-3.5,22.2-8,32.6-13.5l27.7,19.8c5,3.6,11,5.5,17.2,5.5l0,0c7.9,0,15.3-3.1,20.9-8.7l29.8-29.8c10.2-10.2,11.6-26.3,3.2-38.1 l-19.8-27.8c5.5-10.5,10.1-21.4,13.5-32.6l33.6-5.6c14.3-2.4,24.7-14.7,24.7-29.2v-42.1 C478.9,203.801,468.5,191.501,454.2,189.101z M451.9,260.401c0,1.3-0.9,2.4-2.2,2.6l-42,7c-5.3,0.9-9.5,4.8-10.8,9.9 c-3.8,14.7-9.6,28.8-17.4,41.9c-2.7,4.6-2.5,10.3,0.6,14.7l24.7,34.8c0.7,1,0.6,2.5-0.3,3.4l-29.8,29.8c-0.7,0.7-1.4,0.8-1.9,0.8 c-0.6,0-1.1-0.2-1.5-0.5l-34.7-24.7c-4.3-3.1-10.1-3.3-14.7-0.6c-13.1,7.8-27.2,13.6-41.9,17.4c-5.2,1.3-9.1,5.6-9.9,10.8l-7.1,42 c-0.2,1.3-1.3,2.2-2.6,2.2h-42.1c-1.3,0-2.4-0.9-2.6-2.2l-7-42c-0.9-5.3-4.8-9.5-9.9-10.8c-14.3-3.7-28.1-9.4-41-16.8 c-2.1-1.2-4.5-1.8-6.8-1.8c-2.7,0-5.5,0.8-7.8,2.5l-35,24.9c-0.5,0.3-1,0.5-1.5,0.5c-0.4,0-1.2-0.1-1.9-0.8l-29.8-29.8 c-0.9-0.9-1-2.3-0.3-3.4l24.6-34.5c3.1-4.4,3.3-10.2,0.6-14.8c-7.8-13-13.8-27.1-17.6-41.8c-1.4-5.1-5.6-9-10.8-9.9l-42.3-7.2 c-1.3-0.2-2.2-1.3-2.2-2.6v-42.1c0-1.3,0.9-2.4,2.2-2.6l41.7-7c5.3-0.9,9.6-4.8,10.9-10c3.7-14.7,9.4-28.9,17.1-42 c2.7-4.6,2.4-10.3-0.7-14.6l-24.9-35c-0.7-1-0.6-2.5,0.3-3.4l29.8-29.8c0.7-0.7,1.4-0.8,1.9-0.8c0.6,0,1.1,0.2,1.5,0.5l34.5,24.6 c4.4,3.1,10.2,3.3,14.8,0.6c13-7.8,27.1-13.8,41.8-17.6c5.1-1.4,9-5.6,9.9-10.8l7.2-42.3c0.2-1.3,1.3-2.2,2.6-2.2h42.1 c1.3,0,2.4,0.9,2.6,2.2l7,41.7c0.9,5.3,4.8,9.6,10,10.9c15.1,3.8,29.5,9.7,42.9,17.6c4.6,2.7,10.3,2.5,14.7-0.6l34.5-24.8 c0.5-0.3,1-0.5,1.5-0.5c0.4,0,1.2,0.1,1.9,0.8l29.8,29.8c0.9,0.9,1,2.3,0.3,3.4l-24.7,34.7c-3.1,4.3-3.3,10.1-0.6,14.7 c7.8,13.1,13.6,27.2,17.4,41.9c1.3,5.2,5.6,9.1,10.8,9.9l42,7.1c1.3,0.2,2.2,1.3,2.2,2.6v42.1H451.9z"/>
+          <path d="M239.4,136.001c-57,0-103.3,46.3-103.3,103.3s46.3,103.3,103.3,103.3s103.3-46.3,103.3-103.3S296.4,136.001,239.4,136.001 z M239.4,315.601c-42.1,0-76.3-34.2-76.3-76.3s34.2-76.3,76.3-76.3s76.3,34.2,76.3,76.3S281.5,315.601,239.4,315.601z"/>
+        </g>
+      </g>
+    </symbol>
+    <symbol id="icon-teams" viewBox="0 0 131 121">
+      <g transform="translate(0.000000,121.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
+        <path d="M331 1114 c-54 -69 8 -161 90 -132 34 12 63 64 52 95 -23 65 -103 86 -142 37z"/>
+        <path d="M595 1115 c-66 -65 12 -173 95 -130 78 41 52 155 -35 155 -25 0 -44 -8 -60 -25z"/>
+        <path d="M855 1115 c-45 -44 -26 -116 37 -138 29 -10 78 13 94 45 42 81 -66 158 -131 93z"/>
+        <path d="M304 932 c-42 -34 -45 -53 -13 -90 16 -18 29 -43 30 -55 2 -43 -3 -72 -16 -93 -12 -18 -10 -23 20 -50 l33 -29 35 30 35 30 -20 25 c-30 37 -20 105 21 142 17 15 40 28 51 28 34 0 35 22 1 52 -27 24 -39 28 -94 28 -44 0 -68 -6 -83 -18z"/>
+        <path d="M559 921 c-34 -34 -36 -47 -9 -56 60 -19 91 -117 51 -166 -18 -23 -18 -23 17 -56 l35 -34 31 28 c17 16 33 29 34 30 2 1 -3 12 -12 25 -36 50 -9 156 44 173 27 9 25 31 -6 60 -23 21 -37 25 -91 25 -58 0 -68 -3 -94 -29z"/>
+        <path d="M825 925 c-32 -31 -32 -55 -1 -55 74 0 119 -122 67 -184 -7 -8 0 -21 23 -42 l32 -31 32 29 c32 27 32 29 17 58 -8 16 -15 44 -15 62 0 34 32 98 50 98 20 0 10 32 -19 61 -27 26 -36 29 -96 29 -57 0 -69 -3 -90 -25z"/>
+        <path d="M1006 629 l-27 -21 28 -18 c71 -43 92 -112 54 -176 l-22 -37 31 -25 c45 -35 60 -72 60 -147 0 -64 4 -71 34 -59 13 5 16 25 16 114 0 104 1 108 25 124 24 16 25 21 25 107 0 90 0 91 -34 125 -32 32 -38 34 -99 34 -50 0 -70 -5 -91 -21z"/>
+        <path d="M312 565 c-45 -20 -67 -73 -52 -121 33 -98 173 -82 187 22 4 35 1 45 -23 72 -35 38 -69 46 -112 27z"/>
+        <path d="M613 565 c-92 -40 -61 -185 40 -185 102 0 134 140 42 185 -39 18 -41 18 -82 0z"/>
+        <path d="M913 565 c-39 -16 -53 -42 -53 -92 1 -41 13 -63 47 -81 63 -34 143 12 143 83 0 46 -23 81 -62 94 -38 13 -36 13 -75 -4z"/>
+        <path d="M618 350 c-81 -10 -118 -64 -118 -170 0 -101 -1 -100 155 -100 160 0 160 0 153 116 -8 127 -62 171 -190 154z"/>
+        <path d="M922 350 c-38 -4 -58 -12 -75 -30 -21 -23 -22 -33 -19 -133 l3 -107 122 0 c67 0 128 4 136 9 19 12 26 114 12 167 -20 75 -76 105 -179 94z"/>
+        <path d="M251 334 c-34 -24 -51 -75 -51 -153 0 -100 4 -102 154 -99 l121 3 5 105 c5 103 5 105 -22 133 -24 25 -32 27 -105 27 -56 0 -85 -5 -102 -16z"/>
+      </g>
+    </symbol>
+    <symbol id="icon-players" viewBox="0 0 74 159">
+      <g transform="translate(0.000000,159.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
+        <path d="M274 1531 c-18 -11 -39 -30 -48 -42 -21 -31 -20 -93 1 -130 19 -32 92 -74 106 -60 4 4 6 61 5 127 -3 132 -8 140 -64 105z"/>
+        <path d="M360 1421 l0 -130 30 10 c48 17 80 63 80 115 0 59 -21 97 -64 118 -19 9 -37 16 -40 16 -3 0 -6 -58 -6 -129z"/>
+        <path d="M156 1270 c-41 -13 -74 -48 -86 -89 -5 -20 -10 -132 -10 -248 0 -200 1 -214 20 -233 22 -22 46 -25 70 -10 12 7 16 45 20 197 4 121 7 7 8 -318 2 -570 -2 -539 78 -539 78 0 73 -47 75 635 l3 610 -75 2 c-41 1 -87 -2 -103 -7z"/>
+        <path d="M360 672 c0 -577 1 -610 18 -625 21 -19 73 -22 103 -7 18 10 19 23 19 235 l0 225 39 0 c21 0 53 3 70 6 29 6 32 10 26 33 -80 316 -131 531 -126 531 3 0 28 -84 55 -186 51 -189 58 -204 104 -204 49 0 48 17 -23 278 -37 136 -73 259 -81 273 -17 34 -60 49 -140 49 l-64 0 0 -608z"/>
+      </g>
+    </symbol>
+  </svg>
</body>
</html>